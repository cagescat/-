<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­çˆµå°å§çš„å©šäº‹ - AIå‰§æƒ…ç”Ÿæˆç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cormorant Garamond', serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a0806 0%, #1c120e 25%, #2d1b1b 100%);
            color: #f5e9d9;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 15% 25%, rgba(212, 175, 55, 0.08) 0%, transparent 25%),
                radial-gradient(circle at 85% 75%, rgba(184, 148, 31, 0.06) 0%, transparent 25%),
                radial-gradient(circle at 50% 50%, rgba(139, 115, 85, 0.04) 0%, transparent 50%),
                repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(61, 40, 25, 0.03) 2px, rgba(61, 40, 25, 0.03) 4px);
            pointer-events: none;
            z-index: -1;
        }
        
        body::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(180deg, rgba(26, 15, 11, 0.4) 0%, transparent 50%, rgba(26, 15, 11, 0.4) 100%),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><path d="M40,40 L160,40 L160,160 L40,160 Z" fill="none" stroke="%23d4af37" stroke-width="1" stroke-opacity="0.05"/><path d="M20,20 L180,20 L180,180 L20,180 Z" fill="none" stroke="%238b7355" stroke-width="0.5" stroke-opacity="0.03"/></svg>');
            pointer-events: none;
            z-index: -1;
        }
        
        /* åˆå§‹è§’è‰²åˆ›å»ºç•Œé¢ */
        #character-creation {
            width: 100%;
            max-width: 450px;
            height: 720px;
            background: 
                linear-gradient(160deg, #3a2517 0%, #2a1b10 30%, #181008 100%),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path d="M20,20 L80,20 L80,80 L20,80 Z" fill="none" stroke="%23d4af37" stroke-width="2" stroke-opacity="0.15"/><path d="M10,10 L90,10 L90,90 L10,90 Z" fill="none" stroke="%23d4af37" stroke-width="1" stroke-opacity="0.1"/></svg>');
            border-radius: 20px;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.7),
                0 0 0 1px rgba(212, 175, 55, 0.3),
                inset 0 0 30px rgba(212, 175, 55, 0.1),
                inset 0 0 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid #8b7355;
            transform: translateY(0);
            transition: transform 0.5s ease, box-shadow 0.5s ease;
        }
        
        #character-creation:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 30px 60px rgba(0, 0, 0, 0.8),
                0 0 0 1px rgba(212, 175, 55, 0.4),
                inset 0 0 40px rgba(212, 175, 55, 0.15),
                inset 0 0 80px rgba(0, 0, 0, 0.6);
        }
        
        #character-creation-header {
            padding: 25px;
            text-align: center;
            background: linear-gradient(to bottom, rgba(61, 40, 25, 0.9) 0%, rgba(44, 28, 18, 0.9) 100%);
            border-bottom: 1px solid #6d4c3d;
            position: relative;
            overflow: hidden;
        }
        
        #character-creation-header h1 {
            font-size: 24px;
            color: #d4af37;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            font-family: 'Cinzel', serif;
            letter-spacing: 1.5px;
            position: relative;
            display: inline-block;
        }
        
        #character-creation-header h1::after {
            content: "";
            position: absolute;
            bottom: -8px;
            left: 15%;
            width: 70%;
            height: 1px;
            background: linear-gradient(90deg, transparent, #d4af37, transparent);
        }
        
        #character-creation-header p {
            font-size: 14px;
            color: #c9b29a;
            font-style: italic;
            margin-top: 8px;
        }
        
        .creation-form {
            flex-grow: 1;
            padding: 25px;
            overflow-y: auto;
            background-color: rgba(26, 18, 11, 0.85);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-section {
            background: linear-gradient(135deg, rgba(61, 40, 25, 0.7) 0%, rgba(44, 28, 18, 0.7) 100%);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(139, 115, 85, 0.5);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        
        .form-section h2 {
            color: #d4af37;
            font-size: 18px;
            margin-bottom: 15px;
            font-family: 'Cinzel', serif;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-section h2 i {
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-group label {
            display: block;
            color: #e8d8c3;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 15px;
        }
        
        .age-selector {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .age-option {
            flex: 1;
            min-width: 80px;
        }
        
        .age-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to bottom, #8b7355 0%, #6d4c3d 100%);
            border: none;
            border-radius: 8px;
            color: #f5e9d9;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .age-btn:hover {
            background: linear-gradient(to bottom, #9c815e 0%, #7d5a44 100%);
            transform: translateY(-2px);
        }
        
        .age-btn.selected {
            background: linear-gradient(to bottom, #d4af37 0%, #b8941f 100%);
            color: #1a120b;
            box-shadow: 0 5px 10px rgba(212, 175, 55, 0.4);
            border-color: rgba(212, 175, 55, 0.6);
        }
        
        .talent-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .talent-option {
            background: linear-gradient(135deg, rgba(44, 28, 18, 0.9) 0%, rgba(61, 40, 25, 0.9) 100%);
            border-radius: 10px;
            padding: 16px;
            border: 1px solid #6d4c3d;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .talent-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
        }
        
        .talent-option.selected {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(184, 148, 31, 0.2) 100%);
            border-color: #d4af37;
            box-shadow: 0 6px 12px rgba(212, 175, 55, 0.3);
        }
        
        .talent-icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: #d4af37;
            display: block;
        }
        
        .talent-name {
            font-weight: 700;
            color: #d4af37;
            margin-bottom: 6px;
            font-size: 15px;
        }
        
        .talent-description {
            font-size: 13px;
            color: #c9b29a;
            line-height: 1.4;
        }
        
        .creation-footer {
            padding: 20px;
            background: linear-gradient(to top, #3e2723 0%, #2c1c12 100%);
            border-top: 2px solid #6d4c3d;
            text-align: center;
            position: relative;
        }
        
        .creation-footer::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #d4af37, transparent);
        }
        
        #start-game-btn {
            padding: 14px 30px;
            background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
            border: none;
            border-radius: 8px;
            color: #1a120b;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 15px rgba(212, 175, 55, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-family: 'Cinzel', serif;
            letter-spacing: 1px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        #start-game-btn:hover {
            background: linear-gradient(135deg, #e6c158 0%, #c9a327 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.4);
        }
        
        #start-game-btn:active {
            transform: translateY(-1px);
            transition: all 0.1s;
        }
        
        #start-game-btn:disabled {
            background: linear-gradient(135deg, #8b7355 0%, #6d4c3d 100%);
            color: #c9b29a;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .talent-points {
            color: #d4af37;
            font-size: 14px;
            margin-top: 10px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        /* æ¸¸æˆä¸»å®¹å™¨ */
        #game-container {
            width: 100%;
            max-width: 450px;
            height: 750px;
            background: 
                linear-gradient(160deg, #3a2517 0%, #2a1b10 30%, #181008 100%),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path d="M20,20 L80,20 L80,80 L20,80 Z" fill="none" stroke="%23d4af37" stroke-width="2" stroke-opacity="0.15"/><path d="M10,10 L90,10 L90,90 L10,90 Z" fill="none" stroke="%23d4af37" stroke-width="1" stroke-opacity="0.1"/></svg>');
            border-radius: 20px;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.7),
                0 0 0 1px rgba(212, 175, 55, 0.3),
                inset 0 0 30px rgba(212, 175, 55, 0.1),
                inset 0 0 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid #8b7355;
            display: none;
        }
        
        /* è´µæ—çº¹ç« è£…é¥° */
        .heraldic-decoration {
            position: absolute;
            pointer-events: none;
            z-index: 1;
            opacity: 0.2;
            filter: drop-shadow(0 0 5px rgba(212, 175, 55, 0.3));
        }
        
        .decoration-1 {
            top: 15px;
            left: 15px;
            width: 70px;
            height: 70px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50,10 Q70,30 90,50 Q70,70 50,90 Q30,70 10,50 Q30,30 50,10 Z" fill="none" stroke="%23d4af37" stroke-width="2.5"/><circle cx="50" cy="50" r="20" fill="none" stroke="%23d4af37" stroke-width="2"/></svg>');
            background-size: contain;
        }
        
        .decoration-2 {
            bottom: 15px;
            right: 15px;
            width: 60px;
            height: 60px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M20,50 L50,20 L80,50 L50,80 Z" fill="none" stroke="%23d4af37" stroke-width="2.5"/><path d="M35,50 L50,35 L65,50 L50,65 Z" fill="none" stroke="%23d4af37" stroke-width="2"/></svg>');
            background-size: contain;
        }
        
        /* æ»šåŠ¨åˆ°åº•éƒ¨æŒ‰é’® */
        #scroll-to-bottom {
            position: absolute;
            bottom: 150px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(145deg, #d4af37 0%, #b8941f 100%);
            border-radius: 50%;
            border: none;
            color: #1a120b;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 5px 15px rgba(212, 175, 55, 0.5),
                0 0 0 2px rgba(42, 27, 16, 0.8);
            transition: all 0.3s ease;
            z-index: 100;
            opacity: 0;
            transform: translateY(20px);
            visibility: hidden;
        }
        
        #scroll-to-bottom.show {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }
        
        #scroll-to-bottom:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 
                0 8px 25px rgba(212, 175, 55, 0.7),
                0 0 0 2px rgba(42, 27, 16, 0.9);
        }
        
        #scroll-to-bottom:active {
            transform: translateY(-1px) scale(1.05);
        }
        
        /* é¡¶éƒ¨çŠ¶æ€æ  */
        #status-bar {
            background: linear-gradient(to right, #5d4037 0%, #3a2517 50%, #2a1b10 100%);
            color: #f5e9d9;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 15px;
            border-bottom: 2px solid rgba(212, 175, 55, 0.4);
            font-family: 'Cinzel', serif;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            position: relative;
            z-index: 2;
        }
        
        #status-bar::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #d4af37, #b8941f, #d4af37, transparent);
        }
        
        #status-bar::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.6), transparent);
        }
        
        #month-display {
            background-color: rgba(24, 16, 8, 0.8);
            padding: 8px 18px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 
                inset 0 2px 8px rgba(0, 0, 0, 0.5),
                0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        #month-display:hover {
            border-color: rgba(212, 175, 55, 0.5);
            box-shadow: 
                inset 0 2px 8px rgba(0, 0, 0, 0.6),
                0 3px 8px rgba(0, 0, 0, 0.3);
        }
        
        #month-display i {
            margin-right: 10px;
            color: #d4af37;
            text-shadow: 0 0 8px rgba(212, 175, 55, 0.5);
        }
        
        #ai-status {
            display: flex;
            align-items: center;
            background-color: rgba(24, 16, 8, 0.8);
            padding: 8px 18px;
            border-radius: 25px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 
                inset 0 2px 8px rgba(0, 0, 0, 0.5),
                0 2px 5px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #ai-status:hover {
            background-color: rgba(58, 37, 23, 0.9);
            border-color: rgba(212, 175, 55, 0.5);
            transform: translateY(-2px);
            box-shadow: 
                inset 0 2px 8px rgba(0, 0, 0, 0.6),
                0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        #ai-status i {
            margin-right: 10px;
            color: #4CAF50;
            text-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
        }
        
        #ai-status.disconnected i {
            color: #f44336;
            text-shadow: 0 0 8px rgba(244, 67, 54, 0.5);
        }
        
        /* AIè®¾ç½®é¢æ¿ */
        #ai-settings {
            position: absolute;
            top: 70px;
            right: 20px;
            width: 300px;
            background: linear-gradient(145deg, #3a2517 0%, #2a1b10 100%);
            border-radius: 15px;
            padding: 22px;
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.7),
                0 0 0 1px rgba(212, 175, 55, 0.3);
            border: 1px solid rgba(212, 175, 55, 0.4);
            z-index: 1000;
            display: none;
            animation: panelAppear 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);
        }
        
        @keyframes panelAppear {
            0% { 
                opacity: 0; 
                transform: translateY(-20px) scale(0.95); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        #ai-settings h3 {
            color: #f5e9d9;
            margin-bottom: 15px;
            font-family: 'Cinzel', serif;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        #ai-settings h3 i {
            color: #d4af37;
        }
        
        .ai-input-group {
            margin-bottom: 15px;
        }
        
        .ai-input-group label {
            display: block;
            color: #e8d8c3;
            margin-bottom: 6px;
            font-size: 14px;
            padding-left: 5px;
        }
        
        .ai-input-group input,
        .ai-input-group select {
            width: 100%;
            padding: 10px 15px;
            background: linear-gradient(135deg, rgba(24, 16, 8, 0.9) 0%, rgba(42, 27, 16, 0.9) 100%);
            border: 1px solid rgba(109, 76, 61, 0.7);
            border-radius: 8px;
            color: #f5e9d9;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);
        }
        
        .ai-input-group input:focus,
        .ai-input-group select:focus {
            border-color: #d4af37;
            box-shadow: 
                inset 0 2px 8px rgba(0, 0, 0, 0.5),
                0 0 0 3px rgba(212, 175, 55, 0.2);
        }
        
        #ai-save-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(145deg, #d4af37 0%, #b8941f 100%);
            border: none;
            border-radius: 10px;
            color: #1a120b;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 
                0 5px 15px rgba(212, 175, 55, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #ai-save-btn:hover {
            background: linear-gradient(145deg, #e6c158 0%, #c9a327 100%);
            transform: translateY(-2px);
            box-shadow: 
                0 8px 20px rgba(212, 175, 55, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        #ai-settings div[style*="margin-top"] {
            margin-top: 12px;
            font-size: 13px;
            color: #8b7355;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #ai-settings div[style*="margin-top"] i {
            color: #d4af37;
        }
        
        /* æ¸¸æˆæ ‡é¢˜ */
        #game-header {
            padding: 22px;
            text-align: center;
            background: linear-gradient(to bottom, rgba(58, 37, 23, 0.95) 0%, rgba(42, 27, 16, 0.95) 100%);
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        #game-header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #d4af37, #b8941f, #d4af37, transparent);
        }
        
        #game-header::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(139, 115, 85, 0.5), transparent);
        }
        
        #game-header h1 {
            font-size: 24px;
            color: #f5e9d9;
            margin-bottom: 8px;
            text-shadow: 0 2px 8px rgba(212, 175, 55, 0.6), 0 4px 20px rgba(0, 0, 0, 0.8);
            font-family: 'Cinzel', serif;
            letter-spacing: 1.5px;
            position: relative;
            display: inline-block;
            background: linear-gradient(135deg, #f5e9d9 0%, #d4af37 50%, #b8941f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        #game-header h1::after {
            content: "";
            position: absolute;
            bottom: -6px;
            left: 15%;
            width: 70%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #d4af37, #b8941f, #d4af37, transparent);
            border-radius: 2px;
        }
        
        #game-header p {
            font-size: 14px;
            color: #e8d8c3;
            font-style: italic;
            margin-top: 8px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        .progress-container {
            width: 100%;
            height: 6px;
            background: rgba(24, 16, 8, 0.7);
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #8b7355, #d4af37, #b8941f);
            border-radius: 3px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* å¯¹è¯åŒºåŸŸ */
        #chat-area {
            flex-grow: 1;
            padding: 22px;
            overflow-y: auto;
            background-color: rgba(24, 16, 8, 0.92);
            display: flex;
            flex-direction: column;
            gap: 18px;
            scroll-behavior: smooth;
            background-image: 
                linear-gradient(rgba(212, 175, 55, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(212, 175, 55, 0.03) 1px, transparent 1px);
            background-size: 25px 25px;
            position: relative;
        }
        
        #chat-area::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.1), transparent);
        }
        
        .message {
            max-width: 90%;
            padding: 18px 22px;
            border-radius: 15px;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
            animation: messageAppear 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.1);
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(139, 115, 85, 0.3);
            backdrop-filter: blur(5px);
        }
        
        @keyframes messageAppear {
            0% { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .user-message {
            background: linear-gradient(145deg, rgba(93, 64, 55, 0.9) 0%, rgba(58, 37, 23, 0.9) 100%);
            align-self: flex-end;
            border-top-right-radius: 5px;
            color: #f5e9d9;
            border-left: 4px solid #d4af37;
            box-shadow: 
                0 8px 25px rgba(212, 175, 55, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .ai-message {
            background: linear-gradient(145deg, rgba(58, 37, 23, 0.9) 0%, rgba(38, 26, 19, 0.9) 100%);
            align-self: flex-start;
            border-top-left-radius: 5px;
            color: #f5e9d9;
            border-right: 4px solid #8b7355;
        }
        
        .message-sender {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            color: #f5e9d9;
            font-family: 'Cinzel', serif;
            letter-spacing: 0.8px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        .message-sender img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
            border: 1px solid rgba(212, 175, 55, 0.4);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.5);
        }
        
        .message-content {
            font-size: 16px;
            line-height: 1.7;
        }
        
        .system-message {
            background: linear-gradient(145deg, rgba(42, 27, 16, 0.95) 0%, rgba(58, 37, 23, 0.95) 100%);
            align-self: center;
            text-align: center;
            font-size: 14px;
            color: #c9b29a;
            border-radius: 12px;
            padding: 12px 20px;
            border: 1px solid rgba(109, 76, 61, 0.5);
            font-style: italic;
            max-width: 96%;
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        
        /* è¡ŒåŠ¨é€‰æ‹©åŒºåŸŸ */
        #action-area {
            padding: 15px 22px;
            background: linear-gradient(to top, #3a2517 0%, #2a1b10 100%);
            border-top: 2px solid rgba(212, 175, 55, 0.4);
            position: relative;
            min-height: 110px;
            display: flex;
            flex-direction: column;
            user-select: none;
        }
        
        /* è¡ŒåŠ¨æŒ‰é’®å®¹å™¨ */
        #action-buttons-container {
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            padding: 8px 0 12px 0;
            position: relative;
            flex: 1;
            cursor: grab;
            touch-action: pan-x;
            -webkit-overflow-scrolling: touch;
            -webkit-user-select: none;
            user-select: none;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        /* éšè—Webkitæµè§ˆå™¨çš„æ»šåŠ¨æ¡ */
        #action-buttons-container::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }
        
        #action-buttons-container.dragging {
            cursor: grabbing;
        }
        
        /* è¡ŒåŠ¨æŒ‰é’®å¸ƒå±€ */
        #action-buttons {
            display: inline-flex;
            gap: 12px;
            height: 100%;
            align-items: center;
            padding-right: 20px;
        }
        
        /* ä¼˜åŒ–æŒ‰é’®æ ·å¼ */
        .action-btn {
            padding: 12px 16px;
            background: linear-gradient(145deg, #8b7355 0%, #6d4c3d 100%);
            border: none;
            border-radius: 10px;
            color: #f5e9d9;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.2);
            text-align: center;
            min-height: 48px;
            min-width: 100px;
            white-space: nowrap;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* æ·»åŠ æ‹–æ‹½åé¦ˆæ•ˆæœ */
        #action-buttons-container.dragging {
            cursor: grabbing;
        }
        
        #action-buttons-container.dragging .action-btn {
            opacity: 0.95;
            transform: scale(0.98);
        }
        
        /* æ·»åŠ æ»‘åŠ¨è¾¹ç¼˜æç¤º */
        #action-buttons-container::before,
        #action-buttons-container::after {
            content: "";
            position: absolute;
            top: 0;
            width: 20px;
            height: 100%;
            z-index: 2;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        #action-buttons-container::before {
            left: 0;
            background: linear-gradient(90deg, rgba(42, 27, 16, 0.8), transparent);
        }
        
        #action-buttons-container::after {
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(42, 27, 16, 0.8));
        }
        
        #action-buttons-container.can-scroll-left::before {
            opacity: 1;
        }
        
        #action-buttons-container.can-scroll-right::after {
            opacity: 1;
        }
        
        /* è¡ŒåŠ¨ç‚¹æŒ‡ç¤ºå™¨ */
        #action-points {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #c9b29a;
            flex-shrink: 0;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid rgba(139, 115, 85, 0.3);
        }
        
        /* åº•éƒ¨è¾“å…¥åŒºåŸŸ */
        #input-area {
            padding: 20px 22px;
            background: linear-gradient(to top, #2a1b10 0%, #181008 100%);
            border-top: 2px solid rgba(93, 64, 55, 0.5);
            display: flex;
            gap: 15px;
            align-items: center;
            position: relative;
        }
        
        #input-area::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.4), transparent);
        }
        
        #user-input {
            flex-grow: 1;
            padding: 14px 22px;
            border: 1px solid rgba(109, 76, 61, 0.7);
            border-radius: 30px;
            background: linear-gradient(135deg, rgba(24, 16, 8, 0.95) 0%, rgba(42, 27, 16, 0.95) 100%);
            color: #f5e9d9;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 
                inset 0 3px 10px rgba(0, 0, 0, 0.6),
                0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        #user-input:focus {
            border-color: #d4af37;
            box-shadow: 
                inset 0 3px 10px rgba(0, 0, 0, 0.6),
                0 0 0 4px rgba(212, 175, 55, 0.2);
        }
        
        #user-input::placeholder {
            color: #8b7355;
            font-style: italic;
        }
        
        #send-btn {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            background: linear-gradient(145deg, #d4af37 0%, #b8941f 100%);
            color: #1a120b;
            border: none;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 
                0 6px 20px rgba(212, 175, 55, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        #send-btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.7s ease;
        }
        
        #send-btn:hover::before {
            left: 100%;
        }
        
        #send-btn:hover {
            background: linear-gradient(145deg, #e6c158 0%, #c9a327 100%);
            transform: scale(1.12);
            box-shadow: 
                0 10px 30px rgba(212, 175, 55, 0.7),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }
        
        #send-btn:active {
            transform: scale(0.98);
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .typing-indicator {
            display: inline-block;
            margin-left: 12px;
        }
        
        .typing-dot {
            display: inline-block;
            width: 7px;
            height: 7px;
            background-color: #d4af37;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite both;
            box-shadow: 0 0 5px rgba(212, 175, 55, 0.7);
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }
        
       /* æ»šåŠ¨æ¡æ ·å¼ */
        #chat-area::-webkit-scrollbar,
        #action-buttons-container::-webkit-scrollbar,
        .creation-form::-webkit-scrollbar {
            width: 3px !important;
            height: 6px !important;
        }
        
        #chat-area::-webkit-scrollbar-track,
        #action-buttons-container::-webkit-scrollbar-track,
        .creation-form::-webkit-scrollbar-track {
            background: rgba(42, 27, 16, 0.95) !important;
            border-radius: 10px !important;
            margin: 2px !important;
        }
        
        #chat-area::-webkit-scrollbar-thumb,
        #action-buttons-container::-webkit-scrollbar-thumb,
        .creation-form::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #d4af37 0%, #b8941f 100%) !important;
            border-radius: 10px !important;
            border: 1px solid rgba(212, 175, 55, 0.5) !important;
            min-height: 40px !important;
        }
        
        #chat-area::-webkit-scrollbar-thumb:hover,
        #action-buttons-container::-webkit-scrollbar-thumb:hover,
        .creation-form::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #e6c158 0%, #c9a327 100%) !important;
            border: 1px solid rgba(212, 175, 55, 0.8) !important;
        }
        
        #chat-area::-webkit-scrollbar-thumb:active,
        #action-buttons-container::-webkit-scrollbar-thumb:active,
        .creation-form::-webkit-scrollbar-thumb:active {
            background: linear-gradient(to bottom, #b8941f 0%, #9c7a16 100%) !important;
        }
        
        /* ç«ç‹æµè§ˆå™¨æ”¯æŒ */
        #chat-area,
        #action-buttons-container,
        .creation-form {
            scrollbar-width: thin !important;
            scrollbar-color: #d4af37 #2a1b10 !important;
        }
        
        /* ç¡®ä¿æ»šåŠ¨æ¡å§‹ç»ˆå¯è§ */
        #chat-area {
            scrollbar-width: thin;
            overflow-y: scroll !important;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 480px) {
            #character-creation,
            #game-container {
                height: 100vh;
                max-height: 750px;
                border-radius: 0;
            }
            
            body {
                padding: 0;
            }
            
            .talent-grid {
                grid-template-columns: 1fr;
            }
            
            .action-btn {
                padding: 9px 14px;
                font-size: 12px;
            }
            
            .action-btn i {
                font-size: 13px;
            }
            
            .action-btn span {
                max-width: 70px;
            }
            
            #ai-settings {
                width: 280px;
                right: 10px;
            }
            
            #scroll-to-bottom {
                bottom: 15px;
                right: 15px;
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            #character-creation-header h1 {
                font-size: 24px;
            }
            
            #game-header h1 {
                font-size: 22px;
            }
        }
        
        @media (max-width: 380px) {
            .action-btn span {
                max-width: 65px;
            }
            
            #action-buttons {
                gap: 8px;
            }
            
            .age-option {
                min-width: 75px;
            }
            
            #character-creation-header h1 {
                font-size: 22px;
            }
            
            #game-header h1 {
                font-size: 20px;
            }
            
            .talent-option {
                padding: 18px;
            }
        }
        
        /* æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰æ¡†æ ·å¼ */
        select.age-btn {
            background: linear-gradient(135deg, rgba(24, 16, 8, 0.9) 0%, rgba(42, 27, 16, 0.9) 100%);
            color: #f5e9d9;
            border: 1px solid rgba(109, 76, 61, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            outline: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        select.age-btn:focus {
            border-color: #d4af37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
        }
        
        select.age-btn option {
            background-color: #2a1b10;
            color: #f5e9d9;
            padding: 10px;
        }
    </style>
</head>
<body>
    <!-- åˆå§‹è§’è‰²åˆ›å»ºç•Œé¢ -->
    <div id="character-creation">
        <div class="heraldic-decoration decoration-1"></div>
        <div class="heraldic-decoration decoration-2"></div>
        
        <div id="character-creation-header">
            <h1>âœ¨ã€Šå­çˆµå°å§çš„å©šäº‹ã€‹âœ¨</h1>
            <p>å®šåˆ¶ä½ çš„è§’è‰²ï¼Œå¼€å¯å‘½è¿æŠ‰æ‹©ä¹‹æ—…</p>
        </div>
        
        <div class="creation-form">
            <div class="form-section">
                <h2><i class="fas fa-user-crown"></i> è§’è‰²åŸºæœ¬ä¿¡æ¯</h2>
                
                <div class="form-group">
                    <label><i class="fas fa-id-card"></i> å­çˆµå°å§å§“å</label>
                    <input type="text" id="character-name" placeholder="å®‰å¦®Â·åšæ—" value="å®‰å¦®Â·åšæ—" class="age-btn" style="text-align: center;">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-birthday-cake"></i> é€‰æ‹©å¹´é¾„ï¼ˆå½±å“ç¤¾äº¤ç­–ç•¥ï¼‰</label>
                    <div class="age-selector">
                        <div class="age-option">
                            <button class="age-btn" data-age="16">16å²</button>
                        </div>
                        <div class="age-option">
                            <button class="age-btn selected" data-age="18">18å²</button>
                        </div>
                        <div class="age-option">
                            <button class="age-btn" data-age="20">20å²</button>
                        </div>
                        <div class="age-option">
                            <button class="age-btn" data-age="22">22å²</button>
                        </div>
                    </div>
                    <div class="talent-points">å¹´è½»æ›´æœ‰é€‰æ‹©æœºä¼šï¼Œå¹´é•¿æ›´å…·ç¤¾äº¤æ™ºæ…§</div>
                </div>
            </div>
            
            <div class="form-section">
                <h2><i class="fas fa-gem"></i> é€‰æ‹©ä¸¤é¡¹å¤©èµ‹ç‰¹è´¨</h2>
                <p style="color: #c9b29a; font-size: 14px; margin-bottom: 15px;">ä½ çš„å¤©èµ‹å°†å½±å“æ¢ç´¢æ•ˆç‡å’Œæƒ…æŠ¥è´¨é‡</p>
                
                <div class="talent-grid">
                    <div class="talent-option" data-talent="beauty">
                        <div class="talent-icon">ğŸ‘¸</div>
                        <div class="talent-name">å€¾åŸç¾è²Œ</div>
                        <div class="talent-description">ç¤¾äº¤åœºåˆè·å¾—æ›´å¤šå…³æ³¨ï¼Œç»…å£«åˆå§‹å¥½æ„Ÿåº¦+10</div>
                    </div>
                    
                    <div class="talent-option" data-talent="intelligence">
                        <div class="talent-icon">ğŸ§ </div>
                        <div class="talent-name">èªæ…§è¿‡äºº</div>
                        <div class="talent-description">çº¿ç´¢å‘ç°æ¦‚ç‡+30%ï¼Œæ›´å®¹æ˜“è¯†ç ´è°è¨€</div>
                    </div>
                    
                    <div class="talent-option" data-talent="diplomacy">
                        <div class="talent-icon">ğŸ’¬</div>
                        <div class="talent-name">ç¤¾äº¤æ‰‹è…•</div>
                        <div class="talent-description">æ¯æœˆé¢å¤–è·å¾—1ä¸ªè¡ŒåŠ¨ç‚¹ï¼Œäººè„‰å»ºç«‹æ›´å¿«</div>
                    </div>
                    
                    <div class="talent-option" data-talent="intuition">
                        <div class="talent-icon">ğŸ”®</div>
                        <div class="talent-name">æ•é”ç›´è§‰</div>
                        <div class="talent-description">èƒ½æ„ŸçŸ¥éšè—å±é™©ï¼Œé¿å¼€é™·é˜±æ¦‚ç‡+40%</div>
                    </div>
                </div>
                
                <div class="talent-points">å·²é€‰æ‹©: <span id="selected-count">0</span>/2 é¡¹å¤©èµ‹</div>
            </div>
            
            <div class="form-section">
                <h2><i class="fas fa-scroll"></i> æ¸¸æˆè¯´æ˜</h2>
                <div style="background: linear-gradient(145deg, rgba(42, 27, 16, 0.8) 0%, rgba(58, 37, 23, 0.8) 100%); padding: 18px; border-radius: 10px; border-left: 4px solid #d4af37; box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.4);">
                    <p style="color: #f5e9d9; line-height: 1.6; margin-bottom: 12px; font-weight: 500;">
                        ğŸ® <strong>æ ¸å¿ƒæœºåˆ¶ï¼šå‘½è¿ç§˜å¯†æ¡£æ¡ˆ</strong><br>
                        æ¯ä½ç»…å£«éƒ½æœ‰éšæœºç”Ÿæˆçš„éšè—ç§˜å¯†ï¼ŒåŒ…å«å¥½è¿ä¸çˆ†é›·ã€‚
                    </p>
                    <p style="color: #e8d8c3; line-height: 1.5; font-size: 14px; margin-bottom: 10px;">
                        ğŸ•µï¸ <strong>æ¢ç´¢è§„åˆ™ï¼š</strong><br>
                        â€¢ ç¬¬1-3è½®ï¼šğŸ‚ ç§‹å­£æƒ…æŠ¥æ”¶é›†<br>
                        â€¢ ç¬¬4-8è½®ï¼šâ„ï¸ å†¬å­£æ·±åº¦äº¤å¾€<br>
                        â€¢ ç¬¬9-11è½®ï¼šğŸŒ¸ æ˜¥å­£æ±‚å©šçª—å£<br>
                        â€¢ ç¬¬12è½®ï¼šâ˜€ï¸ å¤å­£ç»ˆå±€æ­æ™“
                    </p>
                    <p style="color: #d4af37; line-height: 1.5; font-size: 13px; margin-top: 12px; font-style: italic; font-weight: 500;">
                        ğŸ’¡ æç¤ºï¼šç§˜å¯†åœ¨è®¢å©šæˆ–ç»“å©šå‰ç»ä¸ä¼šç›´æ¥é€éœ²ï¼Œè¯·è°¨æ…æ¢ç´¢
                    </p>
                </div>
            </div>
        </div>
        
        <div class="creation-footer">
            <button id="start-game-btn" disabled>
                <i class="fas fa-play-circle"></i> å¼€å§‹å‘½è¿ä¹‹æ—…
            </button>
            <p style="color: #8b7355; font-size: 13px; margin-top: 12px; font-weight: 500;">
                é€‰æ‹©2é¡¹å¤©èµ‹ç‰¹è´¨ä»¥å¼€å§‹æ¸¸æˆ
            </p>
        </div>
    </div>

    <!-- æ¸¸æˆä¸»å®¹å™¨ -->
    <div id="game-container">
        <div class="heraldic-decoration decoration-1"></div>
        <div class="heraldic-decoration decoration-2"></div>
        
        <!-- æ»šåŠ¨åˆ°åº•éƒ¨æŒ‰é’® -->
        <button id="scroll-to-bottom" title="æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯">
            <i class="fas fa-arrow-down"></i>
        </button>
        
        <!-- çŠ¶æ€æ  -->
        <div id="status-bar">
            <div id="month-display">
                <i class="fas fa-calendar-alt"></i>
                <span id="current-month">ç¬¬1/12è½® â€¢ ç§‹å­£</span>
            </div>
            <div id="ai-status" title="AIå‰§æƒ…ç”ŸæˆçŠ¶æ€">
                <i class="fas fa-robot"></i>
                <span id="ai-status-text">AI:åˆå§‹åŒ–ä¸­...</span>
            </div>
        </div>
        
        <!-- AIè®¾ç½®é¢æ¿ -->
        <div id="ai-settings">
            <h3><i class="fas fa-cog"></i> AI è®¾ç½®</h3>
            <div class="ai-input-group">
                <label for="ai-model">AI æ¨¡å‹:</label>
                <select id="ai-model" class="age-btn" style="text-align: center; width: 100%; padding: 10px;">
                    <option value="deepseek-ai/DeepSeek-OCR" selected>DeepSeek-OCR</option>
                </select>
            </div>
            <div class="ai-input-group">
                <label for="ai-creativity">AIåˆ›é€ åŠ› (0.1-1.0):</label>
                <input type="number" id="ai-creativity" min="0.1" max="1.0" step="0.1" value="0.7" placeholder="0.7">
            </div>
            <button id="ai-save-btn">ä¿å­˜è®¾ç½®</button>
            <div style="margin-top: 10px; font-size: 12px; color: #8b7355;">
                <i class="fas fa-info-circle"></i> æç¤ºï¼šä½¿ç”¨å†…ç½®AIå¼•æ“ç”Ÿæˆæ¸¸æˆå‰§æƒ…
            </div>
        </div>
        
        <!-- æ¸¸æˆæ ‡é¢˜ -->
        <div id="game-header">
            <h1 id="dynamic-title">âœ¨ã€Šå­çˆµå°å§çš„å©šäº‹ã€‹âœ¨</h1>
            <p id="character-info">æ‰®æ¼”å®‰å¦®Â·åšæ—ï¼Œåœ¨12ä¸ªæœˆå†…é€šè¿‡å©šå§»æ‹¯æ•‘å®¶æ—é—äº§</p>
            <div class="progress-container">
                <div class="progress-bar" id="time-progress"></div>
            </div>
        </div>
        
        <!-- å¯¹è¯åŒºåŸŸ -->
        <div id="chat-area">
            <!-- å¯¹è¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- è¡ŒåŠ¨é€‰æ‹©åŒºåŸŸ -->
        <div id="action-area">
            <div id="action-title">
                <i class="fas fa-chess-queen"></i> æœ¬æœˆå¯é‡‡å–çš„è¡ŒåŠ¨
            </div>
            <div id="action-buttons-container">
                <div id="action-buttons">
                    <!-- è¡ŒåŠ¨æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div id="action-points">
                <span>è¡ŒåŠ¨ç‚¹ï¼š</span>
                <div class="action-point available"></div>
                <div class="action-point available"></div>
                <div class="action-point available"></div>
            </div>
        </div>
        
        <!-- è¾“å…¥åŒºåŸŸ -->
        <div id="input-area">
            <input type="text" id="user-input" placeholder="è¾“å…¥å¯¹è¯æˆ–é€‰æ‹©è¡ŒåŠ¨..." maxlength="250" autocomplete="off">
            <button id="send-btn">
                <i class="fas fa-feather-alt"></i>
            </button>
        </div>
    </div>

    <script>
        // å‘½è¿ç§˜å¯†æ¡£æ¡ˆç³»ç»Ÿ
        const FateSecretSystem = {
            // æ ¸å¿ƒæš—ç‰Œåº“
            financialTruths: [
                { id: 1, name: "è™šå‡ç¹è£", description: "è¡¨é¢å¯Œè£•å®åˆ™è´Ÿå€ºç´¯ç´¯" },
                { id: 2, name: "éšå½¢å¯Œè±ª", description: "è¡¨é¢æœ´ç´ å®åˆ™å¯Œå¯æ•Œå›½" },
                { id: 3, name: "ç°é‡‘æµå±æœº", description: "èµ„äº§ä¸°åšä½†ç°é‡‘æµæ–­è£‚" },
                { id: 4, name: "ç»§æ‰¿é£é™©", description: "è´¢äº§ç»§æ‰¿å­˜åœ¨æ³•å¾‹äº‰è®®" },
                { id: 5, name: "æŠ•èµ„æ³¡æ²«", description: "ä¸»è¦è´¢å¯Œæ¥æºå³å°†å´©æºƒ" },
                { id: 6, name: "ç¨³å®šå¢é•¿", description: "è´¢åŠ¡çŠ¶å†µå¥åº·ä¸”ç¨³å®š" }
            ],
            
            marriageMotives: [
                { id: 1, name: "çœŸçˆ±è‡³ä¸Š", description: "çœŸè¯šå¯»æ±‚çµé­‚ä¼´ä¾£" },
                { id: 2, name: "å®¶æ—å‹åŠ›", description: "è¿«äºå®¶æ—å‹åŠ›å¿…é¡»æˆå©š" },
                { id: 3, name: "è´¢åŠ¡æ‹¯æ•‘", description: "æ€¥éœ€å©šå§»è§£å†³è´¢åŠ¡å±æœº" },
                { id: 4, name: "ç¤¾ä¼šåœ°ä½", description: "é€šè¿‡å©šå§»æå‡ç¤¾ä¼šåœ°ä½" },
                { id: 5, name: "å®¶æ—è”å§»", description: "å®Œæˆé¢„å®šçš„å®¶æ—è”å§»" },
                { id: 6, name: "ç§˜å¯†ä½¿å‘½", description: "å©šå§»èƒŒåæœ‰éšè—ç›®çš„" }
            ],
            
            hiddenDeadlines: [
                { id: 1, name: "å€ºåŠ¡åˆ°æœŸ", description: "å·¨é¢å€ºåŠ¡å³å°†åˆ°æœŸ" },
                { id: 2, name: "ç»§æ‰¿æœŸé™", description: "å¿…é¡»åœ¨æœŸé™å†…ç»“å©šæ‰èƒ½ç»§æ‰¿" },
                { id: 3, name: "å•†ä¸šåˆçº¦", description: "å•†ä¸šåˆä½œéœ€è¦å©šå§»è¯æ˜" },
                { id: 4, name: "å¥åº·å±æœº", description: "æœ¬äººæˆ–å®¶äººå¥åº·æ¶åŒ–" },
                { id: 5, name: "ç«äº‰å¯¹æ‰‹", description: "ç«äº‰å¯¹æ‰‹ä¹Ÿåœ¨è¿½æ±‚åŒä¸€ç›®æ ‡" },
                { id: 6, name: "æ— æ˜ç¡®æœŸé™", description: "æ²¡æœ‰ç‰¹åˆ«çš„æ—¶é—´å‹åŠ›" }
            ],
            
            // å¥½è¿å¡åº“
            fortuneCards: [
                { id: 1, name: "æ—©æœŸæŠ•èµ„æˆåŠŸ", description: "å¹´è½»æ—¶æŠ•èµ„è¿æ²³/é“è·¯è·å¾—å·¨å¤§å›æŠ¥" },
                { id: 2, name: "æ„å¤–é—äº§", description: "è¿œæ–¹äº²æˆšæ„å¤–ç•™ä¸‹å¤§ç¬”é—äº§" },
                { id: 3, name: "ä¸“åˆ©å‘æ˜", description: "æ‹¥æœ‰èƒ½æŒç»­äº§ç”Ÿæ”¶ç›Šçš„ä¸“åˆ©" },
                { id: 4, name: "æµ·å¤–è´¸æ˜“", description: "ä¸ä¸œå°åº¦å…¬å¸æœ‰ç§˜å¯†è´¸æ˜“æ¸ é“" },
                { id: 5, name: "åœŸåœ°å¢å€¼", description: "åä¸‹åœŸåœ°å‘ç°çŸ¿è—æˆ–ä½ç½®å¢å€¼" },
                { id: 6, name: "ç‹å®¤èµè¯†", description: "å¾—åˆ°ç‹å®¤æˆå‘˜çš„æš—ä¸­æ”¯æŒ" },
                { id: 7, name: "å†›äº‹æˆ˜åˆ©å“", description: "æˆ˜äº‰æœŸé—´è·å¾—çè´µæˆ˜åˆ©å“" },
                { id: 8, name: "è‰ºæœ¯å“æ”¶è—", description: "æ”¶è—çš„è‰ºæœ¯å“ä»·å€¼è¿åŸ" }
            ],
            
            // çˆ†é›·å¡åº“
            disasterCards: [
                { id: 1, name: "æŠ•èµ„éª—å±€", description: "å·å…¥åºæ°éª—å±€æŸå¤±æƒ¨é‡" },
                { id: 2, name: "å®¶æ—è¯…å’’", description: "å®¶æ—æœ‰é—ä¼ ç–¾ç—…æˆ–è¯…å’’" },
                { id: 3, name: "æ”¿æ²»é£é™©", description: "å·å…¥æ”¿æ²»æ–—äº‰å¯èƒ½å¤±åŠ¿" },
                { id: 4, name: "æ³•å¾‹è¯‰è®¼", description: "é¢ä¸´å·¨é¢èµ”å¿çš„æ³•å¾‹è¯‰è®¼" },
                { id: 5, name: "å•†ä¸šå¤±è´¥", description: "ä¸»è¦ç”Ÿæ„æ¿’ä¸´ç ´äº§" },
                { id: 6, name: "ç§ç”Ÿå­äº‰è®®", description: "æœ‰æœªå…¬å¼€çš„ç§ç”Ÿå­ç»§æ‰¿æƒäº‰è®®" },
                { id: 7, name: "èµŒåšæˆç˜¾", description: "æœ‰ä¸¥é‡çš„èµŒåšå€ºåŠ¡" },
                { id: 8, name: "æ•Œå¯¹å®¶æ—", description: "ä¸å¼ºå¤§æ•Œå¯¹å®¶æ—æœ‰ä¸–ä»‡" }
            ],
            
            // çº¿ç´¢åº“ï¼ˆæŒ‡å‘å…·ä½“äº‹ä»¶è€Œéå¡ç‰Œï¼‰
            clueTemplates: [
                "ä»†äººæåˆ°ä¸»äººæœ€è¿‘é¢‘ç¹ä¸ä¼¦æ•¦å¾‹å¸ˆä¼šé¢",
                "è´¦æˆ¿å…ˆç”Ÿæœ€è¿‘å·¥ä½œåˆ°å¾ˆæ™šï¼Œç¥æƒ…ç„¦è™‘",
                "é©¬å©é‡Œå°‘äº†ä¸¤åŒ¹æœ€å¥½çš„é©¬ï¼Œæ®è¯´æ˜¯å–æ‰äº†",
                "å®…é‚¸çš„æŸäº›æˆ¿é—´é•¿æœŸé”ç€ä¸è®©è¿›å…¥",
                "ç»å¸¸æ”¶åˆ°æ¥è‡ªæµ·å¤–çš„ç¥ç§˜ä¿¡ä»¶",
                "æœ€è¿‘çªç„¶å¼€å§‹å˜å–å®¶æ—æ”¶è—å“",
                "ä¸æŸä½åå£°ä¸ä½³çš„å•†äººæ¥å¾€å¯†åˆ‡",
                "å®¶æ—åŒ»ç”Ÿé¢‘ç¹é€ è®¿ä½†æ‹’ç»é€éœ²åŸå› ",
                "åä¸‹æŸä¸ªåº„å›­çªç„¶æ›´æ¢äº†æ‰€æœ‰ä½ƒå†œ",
                "æœ€è¿‘åœ¨å¤§é‡è´­ä¹°æŸä¸ªç‰¹å®šå…¬å¸çš„è‚¡ç¥¨"
            ],
            
            // ç”Ÿæˆçš„ç§˜å¯†æ¡£æ¡ˆ
            secretArchives: [],
            
            // åˆå§‹åŒ–å‘½è¿ç§˜å¯†ç³»ç»Ÿ
            initialize(gameSessionId) {
                console.log("ğŸ² åˆå§‹åŒ–å‘½è¿ç§˜å¯†ç³»ç»Ÿï¼Œæ¸¸æˆä¼šè¯ID:", gameSessionId);
                this.generateSecretArchives();
                this.logSecretArchives();
            },
            
            // ç¬¬ä¸€æ­¥ï¼šç”ŸæˆåŒ¿åç§˜å¯†æ¡£æ¡ˆï¼ˆå‰¥ç¦»è§’è‰²ï¼‰
            generateSecretArchives() {
                this.secretArchives = [];
                
                for (let i = 0; i < 6; i++) {
                    const archive = {
                        id: i + 1,
                        // æ ¸å¿ƒæš—ç‰Œç»„åˆ
                        financialTruth: this.getRandomItem(this.financialTruths),
                        marriageMotive: this.getRandomItem(this.marriageMotives),
                        hiddenDeadline: this.getRandomItem(this.hiddenDeadlines),
                        // å¥½è¿å¡ï¼ˆ1-2å¼ ï¼‰
                        fortuneCards: this.getRandomCards(this.fortuneCards, 1, 2),
                        // çˆ†é›·å¡ï¼ˆ1-2å¼ ï¼‰
                        disasterCards: this.getRandomCards(this.disasterCards, 1, 2),
                        // çº¿ç´¢ï¼ˆ2-3æ¡ï¼‰
                        clues: this.getRandomClues(2, 3),
                        // æ•…äº‹ï¼ˆç¬¬äºŒæ­¥ç”Ÿæˆï¼‰
                        secretStory: "",
                        // ç»‘å®šçš„è§’è‰²IDï¼ˆç¬¬ä¸‰æ­¥åˆ†é…ï¼‰
                        assignedCharacterId: null
                    };
                    
                    // ç¬¬äºŒæ­¥ï¼šæ„å»ºæ ¸å¿ƒç§˜å¯†å™äº‹
                    archive.secretStory = this.constructSecretStory(archive);
                    
                    this.secretArchives.push(archive);
                }
                
                // ç¬¬ä¸‰æ­¥ï¼šéšæœºåŒ¹é…è§’è‰²
                this.assignToCharacters();
                
                return this.secretArchives;
            },
            
            // æ„å»ºç§˜å¯†æ•…äº‹ï¼ˆåŒ¿åé˜¶æ®µï¼‰
            constructSecretStory(archive) {
                const financial = archive.financialTruth;
                const motive = archive.marriageMotive;
                const deadline = archive.hiddenDeadline;
                const fortune = archive.fortuneCards[0];
                const disaster = archive.disasterCards[0];
                
                const stories = [
                    `ä¸€ä½ç»…å£«å› ${fortune.description}è€Œç§¯ç´¯è´¢å¯Œï¼Œä½†ä¸å¹¸${disaster.description}ã€‚ç°åœ¨ä»–${motive.description}ï¼Œå› ä¸º${deadline.description}ã€‚`,
                    `è¡¨é¢ä¸Šï¼Œè¿™ä½ç»…å£«${financial.description}ï¼Œå®é™…ä¸Šä»–${fortune.description}çš„åŒæ—¶ä¹Ÿ${disaster.description}ã€‚ä»–${motive.description}ï¼Œè¿«åœ¨çœ‰ç«çš„æ˜¯${deadline.description}ã€‚`,
                    `æ—©å¹´${fortune.description}è®©è¿™ä½ç»…å£«çœ‹ä¼¼æˆåŠŸï¼Œä½†${disaster.description}çš„é˜´å½±å§‹ç»ˆç¬¼ç½©ã€‚ä»–${motive.description}ï¼Œç§˜å¯†æœŸé™æ˜¯${deadline.description}ã€‚`
                ];
                
                return this.getRandomItem(stories);
            },
            
            // ç¬¬ä¸‰æ­¥ï¼šéšæœºåˆ†é…ç»™è§’è‰²
            assignToCharacters() {
                // æ‰“ä¹±ç§˜å¯†æ¡£æ¡ˆé¡ºåº
                const shuffledArchives = [...this.secretArchives].sort(() => Math.random() - 0.5);
                
                // åˆ†é…è§’è‰²IDï¼ˆ1-6ï¼‰
                shuffledArchives.forEach((archive, index) => {
                    archive.assignedCharacterId = index + 1;
                });
            },
            
            // è·å–è§’è‰²ç§˜å¯†
            getCharacterSecret(characterId) {
                return this.secretArchives.find(archive => archive.assignedCharacterId === characterId);
            },
            
            // è·å–è§’è‰²çº¿ç´¢ï¼ˆä¸é€éœ²æ ¸å¿ƒç§˜å¯†ï¼‰
            getCharacterClues(characterId, discoveryLevel) {
                const secret = this.getCharacterSecret(characterId);
                if (!secret) return [];
                
                // æ ¹æ®æ¢ç´¢è¿›åº¦è¿”å›çº¿ç´¢
                const clueCount = Math.min(discoveryLevel, secret.clues.length);
                return secret.clues.slice(0, clueCount);
            },
            
            // è·å–éšæœºçº¿ç´¢
            getRandomClues(min, max) {
                const count = Math.floor(Math.random() * (max - min + 1)) + min;
                const shuffledClues = [...this.clueTemplates].sort(() => Math.random() - 0.5);
                return shuffledClues.slice(0, count);
            },
            
            // è¾…åŠ©æ–¹æ³•ï¼šè·å–éšæœºé¡¹
            getRandomItem(array) {
                return array[Math.floor(Math.random() * array.length)];
            },
            
            // è¾…åŠ©æ–¹æ³•ï¼šè·å–éšæœºå¡ç‰‡
            getRandomCards(cardPool, min, max) {
                const count = Math.floor(Math.random() * (max - min + 1)) + min;
                const shuffledCards = [...cardPool].sort(() => Math.random() - 0.5);
                return shuffledCards.slice(0, count);
            },
            
            // æ—¥å¿—è®°å½•ï¼ˆè°ƒè¯•ç”¨ï¼‰
            logSecretArchives() {
                console.group("ğŸ­ å‘½è¿ç§˜å¯†æ¡£æ¡ˆç”Ÿæˆå®Œæˆ");
                this.secretArchives.forEach((archive, index) => {
                    console.group(`æ¡£æ¡ˆ ${index + 1} â†’ è§’è‰² ${archive.assignedCharacterId}`);
                    console.log("ğŸ’° è´¢åŠ¡çœŸç›¸:", archive.financialTruth.name);
                    console.log("ğŸ’ å©šå§»åŠ¨æœº:", archive.marriageMotive.name);
                    console.log("â³ éšè—æ—¶é™:", archive.hiddenDeadline.name);
                    console.log("ğŸ€ å¥½è¿å¡:", archive.fortuneCards.map(c => c.name).join(", "));
                    console.log("ğŸ’¥ çˆ†é›·å¡:", archive.disasterCards.map(c => c.name).join(", "));
                    console.log("ğŸ•µï¸ çº¿ç´¢:", archive.clues.join("; "));
                    console.log("ğŸ“– ç§˜å¯†æ•…äº‹:", archive.secretStory);
                    console.groupEnd();
                });
                console.groupEnd();
            }
        };

        // è§’è‰²åˆ›å»ºçŠ¶æ€
        const characterCreation = {
            name: "å®‰å¦®Â·åšæ—",
            age: 18,
            talents: [],
            maxTalents: 2,
            
            talentEffects: {
                beauty: { name: "å€¾åŸç¾è²Œ", effect: "ç¤¾äº¤åœºåˆè‡ªåŠ¨+10å¥½æ„Ÿåº¦" },
                intelligence: { name: "èªæ…§è¿‡äºº", effect: "çº¿ç´¢å‘ç°æ¦‚ç‡+30%" },
                diplomacy: { name: "ç¤¾äº¤æ‰‹è…•", effect: "è¡ŒåŠ¨ç‚¹æ¢å¤+1æ¯æœˆ" },
                intuition: { name: "æ•é”ç›´è§‰", effect: "è¯†ç ´è°è¨€æ¦‚ç‡+40%" }
            }
        };

        // æ¸¸æˆçŠ¶æ€ç®¡ç†
        const gameState = {
            // è§’è‰²ä¿¡æ¯
            character: {
                name: "",
                age: 18,
                talents: [],
                talentEffects: {}
            },
            
            // æ¸¸æˆåŸºç¡€çŠ¶æ€
            currentMonth: 1,
            totalMonths: 12,
            season: "ç§‹å­£",
            actionPoints: 3,
            maxActionPoints: 3,
            
            // æ¸¸æˆé˜¶æ®µ
            currentPhase: "æƒ…æŠ¥æ”¶é›†æœŸ",
            
            // è§’è‰²æ¢ç´¢è¿›åº¦
            characterDiscovery: {},
            
            // å½“å‰å¯¹è¯è§’è‰²ï¼ˆæ–°å¢ï¼‰
            currentConversationCharacter: null,
            
            // ç”·æ€§è§’è‰²ï¼ˆè¯¦ç»†æ€§æ ¼æè¿°ï¼‰
            maleCharacters: [
                { 
                    id: 1, 
                    name: "ç†æŸ¥å¾·Â·æ¸©æ–¯é¡¿", 
                    title: "å…ˆç”Ÿ", 
                    emoji: "ğŸ’°", 
                    description: "25å²ï¼Œéƒ¡é‡Œæœ€å¯Œæœ‰çš„ç»…å£«ï¼Œåæ‹¥å¸¦æ„å¤§åˆ©å¼èŠ±å›­çš„å±±æ™¯å®…é‚¸",
                    color: "#d4af37",
                    status: "æœªæ¥è§¦",
                    relationship: 0,
                    type: "wealthy",
                    discoveryLevel: 0,
                    personality: "æ¸©å’Œå„’é›…ï¼Œæ…ˆå–„å®¶æ°”è´¨ï¼Œè¨€è¯­å¾—ä½“ï¼Œå–„äºç¤¾äº¤",
                    speechStyle: "æ¸©æ–‡å°”é›…ï¼Œç”¨è¯è€ƒç©¶ï¼Œå¸¸æåŠæŠ•èµ„å’Œæ…ˆå–„"
                },
                { 
                    id: 2, 
                    name: "çˆ±å¾·åÂ·ç§‘ç€", 
                    title: "çˆµå£«", 
                    emoji: "âš”ï¸", 
                    description: "24å²ï¼Œæˆ˜æ–—è‹±é›„ï¼Œå‡­æˆ˜åŠŸå—å°çˆµå£«ï¼Œé¢†æ”¿åºœå¹´é‡‘åº¦æ—¥",
                    color: "#8b7355",
                    status: "æœªæ¥è§¦",
                    relationship: 0,
                    type: "military",
                    discoveryLevel: 0,
                    personality: "ä¸¥è‚ƒæ­£ç›´ï¼Œå†›äººä½œé£ï¼Œè¯è¯­ç®€æ´ç›´æ¥",
                    speechStyle: "è¨€ç®€æ„èµ…ï¼Œå¶å°”å¼•ç”¨å†›äº‹æœ¯è¯­ï¼Œé‡è§†è£èª‰"
                },
                { 
                    id: 3, 
                    name: "æŸ¥ç†Â·éœåå¾·", 
                    title: "å‹‹çˆµ", 
                    emoji: "ğŸ°", 
                    description: "21å²ï¼Œä¼¯çˆµä¹‹å­ï¼Œæœªæ¥çš„ä¼¯çˆµç»§æ‰¿äººï¼Œæ¸©æ³‰ç¤¾äº¤å­£éšçˆ¶æ¯åˆ°è®¿",
                    color: "#c9b29a",
                    status: "æœªæ¥è§¦",
                    relationship: 0,
                    type: "noble",
                    discoveryLevel: 0,
                    personality: "ä¼˜é›…è‡ªä¿¡ï¼Œè´µæ—é£èŒƒï¼Œç•¥å¸¦å‚²æ…¢",
                    speechStyle: "è´µæ—å¼ç¤¼è²Œï¼Œå¼•ç”¨å¤å…¸æ–‡å­¦ï¼Œé‡è§†ç¤¼ä»ª"
                },
                { 
                    id: 4, 
                    name: "å¡ç¼ªå°”Â·æ ¼æ—", 
                    title: "å…ˆç”Ÿ", 
                    emoji: "ğŸŒ¾", 
                    description: "19å²ï¼Œæœ¬åœ°ä¹¡ç»…é•¿å­ï¼ŒåŠ¡å®å¯é çš„å†œåœºç®¡ç†è€…",
                    color: "#7d9c6d",
                    status: "æœªæ¥è§¦",
                    relationship: 0,
                    type: "practical",
                    discoveryLevel: 0,
                    personality: "æ†¨åšå®åœ¨ï¼Œæ¥åœ°æ°”ï¼Œå…³å¿ƒåœŸåœ°å’Œæ”¶æˆ",
                    speechStyle: "ç›´ç‡æœ´å®ï¼Œå¸¸æå†œåœºå’Œå¤©æ°”ï¼Œè¯è¯­å®åœ¨"
                },
                { 
                    id: 5, 
                    name: "å¨å»‰Â·å¡ç‰¹", 
                    title: "å…ˆç”Ÿ", 
                    emoji: "ğŸ“œ", 
                    description: "20å²ï¼Œä»ä¼¦æ•¦æ¥çš„æ–°é”å¾‹å¸ˆï¼Œæš‚å±…å§¨æ¯å®¶ä¸­",
                    color: "#6d8b9c",
                    status: "æœªæ¥è§¦",
                    relationship: 0,
                    type: "intellectual",
                    discoveryLevel: 0,
                    personality: "æœºæ™ºæ•é”ï¼Œå–„äºè¾©è®ºï¼Œå…³æ³¨æ—¶äº‹æ³•å¾‹",
                    speechStyle: "é€»è¾‘æ¸…æ™°ï¼Œç•¥å¸¦æ³•å¾‹æœ¯è¯­ï¼Œå¹½é»˜é£è¶£"
                },
                { 
                    id: 6, 
                    name: "ä¹”æ²»Â·å¥¥æ–¯æœ¬", 
                    title: "ç”·çˆµ", 
                    emoji: "ğŸ•¯ï¸", 
                    description: "23å²ï¼Œå¹´è½»ç”·çˆµï¼Œç»§æ‰¿çˆµä½ä¸åº„å›­ï¼Œä¸æ¯äº²ç›¸ä¾ä¸ºå‘½",
                    color: "#9c6d8b",
                    status: "æœªæ¥è§¦",
                    relationship: 0,
                    type: "mysterious",
                    discoveryLevel: 0,
                    personality: "å†…æ•›ç¥ç§˜ï¼Œè¯ä¸å¤šä½†æ·±æ€ç†Ÿè™‘",
                    speechStyle: "æªè¾è°¨æ…ï¼Œç•¥å¸¦å¿§éƒï¼Œè¯è¯­æœ‰æ·±æ„"
                }
            ],
            
            // è¡ŒåŠ¨å®šä¹‰
            availableActions: [
                { 
                    id: "social", 
                    name: "ç¤¾äº¤çª¥æ¢ ğŸ‰", 
                    icon: "fa-glass-cheers", 
                    description: "å‚åŠ èˆä¼šæˆ–èŒ¶ä¼šï¼Œæ”¶é›†å…³äºç»…å£«ä»¬çš„åŠé—´ä¼ è¨€",
                    cost: 1,
                    shortName: "ç¤¾äº¤",
                    discoveryType: "general"
                },
                { 
                    id: "visit", 
                    name: "ç§ä¸‹æ‹œè®¿ ğŸšª", 
                    icon: "fa-home", 
                    description: "å‰å¾€ç›®æ ‡ç»…å£«çš„ä½å¤„ï¼Œè§‚å¯Ÿç”Ÿæ´»ç»†èŠ‚",
                    cost: 1,
                    shortName: "æ‹œè®¿",
                    discoveryType: "specific"
                },
                { 
                    id: "letter", 
                    name: "ä¿¡ä»¶è¿½é—® âœ‰ï¸", 
                    icon: "fa-envelope", 
                    description: "é€šè¿‡ä¹¦ä¿¡å¾€æ¥äº†è§£ç»…å£«çš„å“å‘³ä¸çœŸå®æ„å›¾",
                    cost: 1,
                    shortName: "ä¿¡ä»¶",
                    discoveryType: "personal"
                },
                { 
                    id: "mother", 
                    name: "æ¯äº²æ‰“å¬ ğŸ—£ï¸", 
                    icon: "fa-female", 
                    description: "è¯·æ¯äº²åŠ¨ç”¨æ—§äººè„‰ç½‘ç»œï¼Œäº†è§£å®¶æ—èƒŒæ™¯",
                    cost: 1,
                    shortName: "æ¯äº²",
                    discoveryType: "background"
                },
                { 
                    id: "maid", 
                    name: "å¥³ä»†ä¾¦æŸ¥ ğŸ‘©ğŸ»", 
                    icon: "fa-user-secret", 
                    description: "æ´¾é£å¥³ä»†ä¸å¯¹æ–¹ä»†äººäº¤æµï¼Œè·å–å†…éƒ¨ä¿¡æ¯",
                    cost: 1,
                    shortName: "å¥³ä»†",
                    discoveryType: "internal"
                },
                { 
                    id: "chat", 
                    name: "è‡ªç”±äº¤è°ˆ ğŸ’¬", 
                    icon: "fa-comments", 
                    description: "ä¸å½“å‰åœºæ™¯ä¸­çš„è§’è‰²è¿›è¡Œè‡ªç”±å¯¹è¯",
                    cost: 0,
                    shortName: "äº¤è°ˆ",
                    discoveryType: "relationship"
                }
            ],
            
            // AIé…ç½®
            aiConfig: {
                apiKey: "sk-cdxiuecjtmjndhytjhkkxzpczlfevwvujbfffhhzqqgwifxx",
                apiUrl: "https://api.siliconflow.cn/v1",
                model: "deepseek-ai/DeepSeek-OCR",
                creativity: 0.7,
                isConnected: false,
                useAI: true
            },
            
            // æ¸¸æˆä¼šè¯ID
            sessionId: Date.now().toString(36) + Math.random().toString(36).substr(2),
            
            // å…¶ä»–çŠ¶æ€
            usedDialogue: new Set(),
            isAIResponding: false,
            messageQueue: []
        };

        // æ»šåŠ¨åˆ°åº•éƒ¨åŠŸèƒ½
        const ScrollManager = {
            chatArea: null,
            scrollButton: null,
            isAtBottom: true,
            lastScrollTop: 0,
            
            init() {
                this.chatArea = document.getElementById('chat-area');
                this.scrollButton = document.getElementById('scroll-to-bottom');
                
                if (!this.chatArea || !this.scrollButton) return;
                
                this.chatArea.addEventListener('scroll', () => {
                    this.checkScrollPosition();
                });
                
                this.scrollButton.addEventListener('click', () => {
                    this.scrollToBottom();
                });
                
                this.checkScrollPosition();
            },
            
            checkScrollPosition() {
                const scrollTop = this.chatArea.scrollTop;
                const scrollHeight = this.chatArea.scrollHeight;
                const clientHeight = this.chatArea.clientHeight;
                
                this.isAtBottom = scrollHeight - scrollTop - clientHeight < 50;
                
                if (this.isAtBottom) {
                    this.scrollButton.classList.remove('show');
                } else {
                    this.scrollButton.classList.add('show');
                }
                
                this.lastScrollTop = scrollTop;
            },
            
            scrollToBottom() {
                this.chatArea.scrollTo({
                    top: this.chatArea.scrollHeight,
                    behavior: 'smooth'
                });
            },
            
            forceScrollCheck() {
                setTimeout(() => {
                    this.checkScrollPosition();
                }, 100);
            }
        };

        // è§’è‰²åˆ›å»ºç•Œé¢ç®¡ç†
        const CharacterCreationManager = {
            init() {
                this.setupEventListeners();
                this.updateStartButton();
            },
            
            setupEventListeners() {
                // å¹´é¾„é€‰æ‹©
                document.querySelectorAll('.age-btn[data-age]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const age = parseInt(e.target.dataset.age);
                        this.selectAge(age);
                    });
                });
                
                // å¤©èµ‹é€‰æ‹©
                document.querySelectorAll('.talent-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        const talent = e.currentTarget.dataset.talent;
                        this.toggleTalent(talent);
                    });
                });
                
                // è§’è‰²åè¾“å…¥
                document.getElementById('character-name').addEventListener('input', (e) => {
                    characterCreation.name = e.target.value.trim() || "å®‰å¦®Â·åšæ—";
                });
                
                // å¼€å§‹æ¸¸æˆæŒ‰é’®
                document.getElementById('start-game-btn').addEventListener('click', () => {
                    this.startGame();
                });
            },
            
            selectAge(age) {
                characterCreation.age = age;
                document.querySelectorAll('.age-btn[data-age]').forEach(btn => {
                    btn.classList.remove('selected');
                    if (parseInt(btn.dataset.age) === age) {
                        btn.classList.add('selected');
                    }
                });
            },
            
            toggleTalent(talent) {
                const index = characterCreation.talents.indexOf(talent);
                const talentElement = document.querySelector(`.talent-option[data-talent="${talent}"]`);
                
                if (index === -1) {
                    if (characterCreation.talents.length < characterCreation.maxTalents) {
                        characterCreation.talents.push(talent);
                        talentElement.classList.add('selected');
                    } else {
                        const firstTalent = characterCreation.talents[0];
                        const firstElement = document.querySelector(`.talent-option[data-talent="${firstTalent}"]`);
                        
                        firstElement.classList.remove('selected');
                        characterCreation.talents.shift();
                        characterCreation.talents.push(talent);
                        talentElement.classList.add('selected');
                    }
                } else {
                    characterCreation.talents.splice(index, 1);
                    talentElement.classList.remove('selected');
                }
                
                this.updateSelectedCount();
                this.updateStartButton();
            },
            
            updateSelectedCount() {
                document.getElementById('selected-count').textContent = characterCreation.talents.length;
            },
            
            updateStartButton() {
                const startBtn = document.getElementById('start-game-btn');
                startBtn.disabled = characterCreation.talents.length !== characterCreation.maxTalents;
            },
            
            startGame() {
                // ä¿å­˜è§’è‰²æ•°æ®
                gameState.character.name = characterCreation.name;
                gameState.character.age = characterCreation.age;
                gameState.character.talents = [...characterCreation.talents];
                
                // åˆå§‹åŒ–å‘½è¿ç§˜å¯†ç³»ç»Ÿ
                FateSecretSystem.initialize(gameState.sessionId);
                
                // è®¡ç®—å¤©èµ‹æ•ˆæœ
                this.calculateTalentEffects();
                
                // æ›´æ–°æ¸¸æˆæ ‡é¢˜
                document.getElementById('dynamic-title').textContent = `âœ¨ã€Š${characterCreation.name}çš„å©šäº‹ã€‹âœ¨`;
                document.getElementById('character-info').textContent = 
                    `æ‰®æ¼”${characterCreation.name}ï¼ˆ${characterCreation.age}å²ï¼‰ï¼Œæ¢ç´¢å‘½è¿ç§˜å¯†`;
                
                // åˆ‡æ¢åˆ°æ¸¸æˆç•Œé¢
                document.getElementById('character-creation').style.display = 'none';
                document.getElementById('game-container').style.display = 'flex';
                
                // åˆå§‹åŒ–æ»šåŠ¨ç®¡ç†å™¨
                ScrollManager.init();
                
                // åˆå§‹åŒ–æ¸¸æˆ
                initGame();
            },
            
            calculateTalentEffects() {
                gameState.character.talentEffects = {};
                
                characterCreation.talents.forEach(talent => {
                    if (characterCreation.talentEffects[talent]) {
                        gameState.character.talentEffects[talent] = characterCreation.talentEffects[talent];
                    }
                });
                
                if (characterCreation.talents.includes('diplomacy')) {
                    gameState.maxActionPoints = 4;
                    gameState.actionPoints = 4;
                }
            }
        };

        // æ¸¸æˆæ ¸å¿ƒç³»ç»Ÿ
        const GameSystem = {
            // æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º
            updateStatusDisplay() {
                document.getElementById('current-month').textContent = 
                    `ç¬¬${gameState.currentMonth}/${gameState.totalMonths}è½® â€¢ ${gameState.season}`;
                
                const progressPercent = (gameState.currentMonth / gameState.totalMonths) * 100;
                document.getElementById('time-progress').style.width = `${progressPercent}%`;
                
                // æ›´æ–°é˜¶æ®µæ˜¾ç¤º
                this.updatePhase();
            },
            
            // æ›´æ–°æ¸¸æˆé˜¶æ®µ
            updatePhase() {
                if (gameState.currentMonth <= 3) {
                    gameState.currentPhase = "æƒ…æŠ¥æ”¶é›†æœŸ";
                    gameState.season = "ç§‹å­£";
                } else if (gameState.currentMonth <= 8) {
                    gameState.currentPhase = "æ·±åº¦äº¤å¾€æœŸ";
                    gameState.season = "å†¬å­£";
                } else if (gameState.currentMonth <= 11) {
                    gameState.currentPhase = "æ±‚å©šçª—å£æœŸ";
                    gameState.season = "æ˜¥å­£";
                } else {
                    gameState.currentPhase = "ç»ˆå±€æ­æ™“æœŸ";
                    gameState.season = "å¤å­£";
                }
            },
            
            // æ›´æ–°è¡ŒåŠ¨æŒ‰é’®
            updateActionButtons() {
                const actionButtons = document.getElementById('action-buttons');
                actionButtons.innerHTML = '';
                
                gameState.availableActions.forEach(action => {
                    const button = document.createElement('button');
                    button.className = 'action-btn';
                    button.innerHTML = `<i class="fas ${action.icon}"></i> <span>${action.shortName || action.name}</span>`;
                    button.title = action.description;
                    button.dataset.actionId = action.id;
                    
                    if (gameState.actionPoints < action.cost) {
                        button.style.opacity = '0.6';
                        button.style.cursor = 'not-allowed';
                        button.title = `è¡ŒåŠ¨ç‚¹ä¸è¶³ï¼ˆéœ€è¦${action.cost}ç‚¹ï¼‰`;
                    } else {
                        button.addEventListener('click', () => {
                            handleAction(action.id);
                        });
                    }
                    
                    actionButtons.appendChild(button);
                });
                
                this.updateActionPointsDisplay();
            },
            
            // æ›´æ–°è¡ŒåŠ¨ç‚¹æ˜¾ç¤º
            updateActionPointsDisplay() {
                const actionPointsContainer = document.getElementById('action-points');
                const pointsSpan = actionPointsContainer.querySelector('span');
                pointsSpan.textContent = `è¡ŒåŠ¨ç‚¹ï¼š${gameState.actionPoints}/${gameState.maxActionPoints}`;
                
                const pointElements = actionPointsContainer.querySelectorAll('.action-point');
                pointElements.forEach((point, index) => {
                    point.className = 'action-point';
                    if (index < gameState.actionPoints) {
                        point.classList.add('available');
                    } else {
                        point.classList.add('used');
                    }
                });
            },
            
            // æ¨è¿›æœˆä»½
            advanceMonth() {
                gameState.currentMonth++;
                gameState.actionPoints = gameState.maxActionPoints;
                
                this.updatePhase();
                this.updateStatusDisplay();
                this.updateActionPointsDisplay();
                this.updateActionButtons();
                
                setTimeout(() => {
                    MessageSystem.createMessage("æ¸¸æˆä¸»æŒ", 
                        `ğŸ•°ï¸ **ç¬¬${gameState.currentMonth}/12ä¸ªæœˆ - ${gameState.season}**\n\n` +
                        `æ—¶å…‰é£é€ï¼Œ${gameState.season}çš„å¾®é£å¸¦æ¥äº†æ–°çš„æœºé‡ä¸æŒ‘æˆ˜ã€‚\n` +
                        `ä½ æœ‰${gameState.actionPoints}ä¸ªè¡ŒåŠ¨ç‚¹å¯ä»¥æ”¯é…ï¼Œ${gameState.currentPhase}æ­£åœ¨è¿›è¡Œä¸­ã€‚`,
                        "ai"
                    );
                }, 800);
            },
            
            // è®¾ç½®å½“å‰å¯¹è¯è§’è‰²
            setCurrentConversationCharacter(characterId) {
                if (characterId === null) {
                    gameState.currentConversationCharacter = null;
                    document.getElementById('user-input').placeholder = "è¾“å…¥å¯¹è¯æˆ–é€‰æ‹©è¡ŒåŠ¨...";
                    return;
                }
                
                const character = gameState.maleCharacters.find(c => c.id === characterId);
                if (character) {
                    gameState.currentConversationCharacter = character;
                    document.getElementById('user-input').placeholder = `ä¸${character.name}${character.title}äº¤è°ˆ...`;
                }
            },
            
            // æ¢ç´¢ç³»ç»Ÿ
            ExplorationSystem: {
                executeExploration(actionId, targetCharacterId) {
                    const action = gameState.availableActions.find(a => a.id === actionId);
                    if (!action) return null;
                    
                    if (action.cost > 0) {
                        gameState.actionPoints -= action.cost;
                        GameSystem.updateActionPointsDisplay();
                        GameSystem.updateActionButtons();
                    }
                    
                    return this.generateExplorationResult(actionId, targetCharacterId);
                },
                
                generateExplorationResult(actionId, targetCharacterId) {
                    const character = gameState.maleCharacters.find(c => c.id === targetCharacterId);
                    if (!character) return null;
                    
                    character.discoveryLevel = Math.min(character.discoveryLevel + 1, 5);
                    
                    const secret = FateSecretSystem.getCharacterSecret(targetCharacterId);
                    const clues = FateSecretSystem.getCharacterClues(targetCharacterId, character.discoveryLevel);
                    
                    let talentBonus = "";
                    if (gameState.character.talents.includes('intelligence')) {
                        if (Math.random() > 0.7) {
                            const extraClues = FateSecretSystem.getRandomClues(1, 1);
                            clues.push(...extraClues);
                            talentBonus = " ğŸ§ ä½ çš„èªæ…§è®©ä½ å‘ç°äº†é¢å¤–çº¿ç´¢ï¼";
                        }
                    }
                    
                    let result = "";
                    switch(actionId) {
                        case 'social':
                            result = this.generateSocialResult(character, clues);
                            break;
                        case 'visit':
                            result = this.generateVisitResult(character, clues);
                            break;
                        case 'letter':
                            result = this.generateLetterResult(character, clues);
                            break;
                        case 'mother':
                            result = this.generateMotherResult(character, clues);
                            break;
                        case 'maid':
                            result = this.generateMaidResult(character, clues);
                            break;
                        default:
                            result = this.generateGeneralResult(character, clues);
                    }
                    
                    return result + talentBonus;
                },
                
                generateSocialResult(character, clues) {
                    const socialSettings = [
                        "æ¸©æ–¯é¡¿å®…é‚¸çš„ç§‹å­£èˆä¼š",
                        "ç§‘ç€çˆµå£«çš„å†›å®˜èŒ¶ä¼š",
                        "éœåå¾·å®¶çš„ç§å¯†æ™šå®´",
                        "æ ¼æ—å®¶çš„ä¸°æ”¶åº†ç¥",
                        "å¡ç‰¹å¾‹å¸ˆçš„ä¹¦å‹ä¼š",
                        "å¥¥æ–¯æœ¬ç”·çˆµçš„çƒ›å…‰éŸ³ä¹ä¼š"
                    ];
                    
                    const setting = socialSettings[character.id - 1] || "æœ¬æœˆçš„ç¤¾äº¤æ´»åŠ¨";
                    
                    return `ğŸ’ƒ **${setting}ä¸Šçš„è§‚å¯Ÿ**\n\n` +
                           `åœ¨${setting}ä¸Šï¼Œä½ æ³¨æ„åˆ°å…³äº${character.name}${character.title}çš„ä¸€äº›ç»†èŠ‚ï¼š\n` +
                           `â€¢ ${clues[0] || "ä»–åœ¨ç¤¾äº¤åœºåˆè¡¨ç°å¾—ä½“ï¼Œä½†å¶å°”ä¼šèµ°ç¥"}\n` +
                           `â€¢ ${clues[1] || "ä¸å…¶ä»–ç»…å£«çš„äº¤æµä¼¼ä¹æœ‰æ‰€ä¿ç•™"}`;
                },
                
                generateVisitResult(character, clues) {
                    return `ğŸšª **æ‹œè®¿${character.name}${character.title}çš„å®…é‚¸**\n\n` +
                           `åœ¨æ­£å¼æ‹œè®¿ä¸­ï¼Œä½ è§‚å¯Ÿåˆ°ï¼š\n` +
                           `â€¢ ${clues[0] || "å®…é‚¸è£…é¥°ç²¾è‡´ï¼Œä½†æŸäº›åŒºåŸŸä¼¼ä¹ç–äºç»´æŠ¤"}\n` +
                           `â€¢ ${clues[1] || "ä»†äººä»¬ä¸¾æ­¢å¾—ä½“ï¼Œä½†æ˜¾å¾—æœ‰äº›ç´§å¼ "}\n` +
                           `â€¢ ä¹¦æˆ¿é‡Œæ‘†æ”¾ç€è®¸å¤šä¹¦ç±ï¼Œå…¶ä¸­ä¸€äº›æœ‰æ˜æ˜¾ç¿»é˜…ç—•è¿¹`;
                },
                
                generateLetterResult(character, clues) {
                    return `âœ‰ï¸ **ä¸${character.name}${character.title}çš„ä¿¡ä»¶å¾€æ¥**\n\n` +
                           `åœ¨ä¹¦ä¿¡äº¤æµä¸­ï¼Œä½ å‘ç°ï¼š\n` +
                           `â€¢ ${clues[0] || "ä»–çš„æ–‡å­—ä¼˜é›…ï¼Œä½†æŸäº›è¯é¢˜æ€»æ˜¯å›é¿"}\n` +
                           `â€¢ å›ä¿¡é€Ÿåº¦${Math.random() > 0.5 ? "å¾ˆå¿«ï¼Œä¼¼ä¹å¾ˆæœŸå¾…äº¤æµ" : "è¾ƒæ…¢ï¼Œå¯èƒ½äº‹åŠ¡ç¹å¿™"}\n` +
                           `â€¢ å­—é‡Œè¡Œé—´é€éœ²å‡º${Math.random() > 0.5 ? "å¯¹æœªæ¥çš„æœŸå¾…" : "ä¸€ä¸ä¸æ˜“å¯Ÿè§‰çš„ç„¦è™‘"}`;
                },
                
                generateMotherResult(character, clues) {
                    return `ğŸ‘©â€ğŸ¦³ **æ¯äº²æä¾›çš„å®¶æ—æƒ…æŠ¥**\n\n` +
                           `æ¯äº²åŠ¨ç”¨äººè„‰åå‘Šè¯‰ä½ ï¼š\n` +
                           `â€¢ "${clues[0] || character.name}å®¶æ—åœ¨æœ¬åœ°æœ‰è‰¯å¥½å£°èª‰"}\n` +
                           `â€¢ "${clues[1] || "ä½†æœ€è¿‘ä¼¼ä¹æœ‰äº›è´¢åŠ¡ä¸Šçš„å˜åŠ¨"}"\n` +
                           `â€¢ "æˆ‘å¹´è½»æ—¶è®¤è¯†ä»–çš„ä¸€ä½è¿œäº²ï¼Œæ®è¯´..."ï¼ˆæ¯äº²æ¬²è¨€åˆæ­¢ï¼‰`;
                },
                
                generateMaidResult(character, clues) {
                    return `ğŸ‘©ğŸ» **å¥³ä»†çå¦®çš„å†…éƒ¨æ¶ˆæ¯**\n\n` +
                           `çå¦®å‹ä½å£°éŸ³æ±‡æŠ¥ï¼š\n` +
                           `â€¢ "å°å§ï¼Œæˆ‘åœ¨å¸‚åœºä¸Šé‡åˆ°${character.name}å®¶çš„å¨å¨˜ï¼Œå¥¹è¯´${clues[0] || "æœ€è¿‘ä¸»äººç»å¸¸ç‹¬è‡ªåœ¨ä¹¦æˆ¿å¾…åˆ°æ·±å¤œ"}"\n` +
                           `â€¢ "${clues[1] || "å®…é‚¸é‡Œæœ‰äº›æˆ¿é—´é•¿æœŸé”ç€"}"\n` +
                           `â€¢ "æˆ‘è¿˜å¬è¯´..."ï¼ˆçå¦®çªç„¶è¢«è„šæ­¥å£°æ‰“æ–­ï¼‰`;
                },
                
                generateGeneralResult(character, clues) {
                    return `ğŸ” **å…³äº${character.name}${character.title}çš„å‘ç°**\n\n` +
                           `é€šè¿‡è§‚å¯Ÿå’Œæ‰“å¬ï¼Œä½ äº†è§£åˆ°ï¼š\n` +
                           clues.map(clue => `â€¢ ${clue}`).join('\n');
                }
            }
        };

        // æ¶ˆæ¯ç³»ç»Ÿ
        const MessageSystem = {
            createMessage(sender, content, type = "ai") {
                const chatArea = document.getElementById('chat-area');
                
                if (type === "ai" && gameState.isAIResponding) {
                    gameState.messageQueue.push({ sender, content, type });
                    return;
                }
                
                if (type === "ai") gameState.isAIResponding = true;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type === "user" ? "user-message" : "ai-message"}`;
                
                const displayName = type === "user" ? gameState.character.name || "å®‰å¦®Â·åšæ—" : sender;
                
                let avatarSvg;
                if (type === "user") {
                    avatarSvg = this.generateAvatarSVG("user", sender);
                } else {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç”·æ€§è§’è‰²
                    const maleCharacter = gameState.maleCharacters.find(c => sender.includes(c.name));
                    if (maleCharacter) {
                        avatarSvg = this.generateCharacterAvatar(maleCharacter);
                    } else {
                        avatarSvg = this.generateAvatarSVG("ai", sender);
                    }
                }
                
                messageDiv.innerHTML = `
                    <div class="message-sender">
                        <img src="data:image/svg+xml;utf8,${encodeURIComponent(avatarSvg)}" class="avatar" />
                        <span>${displayName}</span>
                    </div>
                    <div class="message-content">${this.decorateMessage(content)}</div>
                `;
                
                chatArea.appendChild(messageDiv);
                
                if (ScrollManager.isAtBottom) {
                    setTimeout(() => {
                        ScrollManager.scrollToBottom();
                    }, 50);
                } else {
                    ScrollManager.forceScrollCheck();
                }
                
                if (type === "ai") {
                    setTimeout(() => {
                        gameState.isAIResponding = false;
                        this.processMessageQueue();
                    }, 1000);
                }
                
                return messageDiv;
            },
            
            processMessageQueue() {
                if (gameState.messageQueue.length > 0 && !gameState.isAIResponding) {
                    const message = gameState.messageQueue.shift();
                    this.createMessage(message.sender, message.content, message.type);
                    
                    if (gameState.messageQueue.length > 0) {
                        setTimeout(() => this.processMessageQueue(), 800);
                    }
                }
            },
            
            generateAvatarSVG(type, sender) {
                const colors = {
                    user: { bg: "#d4af37", text: "#1a120b", letter: "A" },
                    ai: { bg: "#5d4037", text: "#f5e9d9", letter: "G" },
                    system: { bg: "#8b7355", text: "#f5e9d9", letter: "S" }
                };
                
                const config = colors[type === "user" ? "user" : type === "system" ? "system" : "ai"];
                
                return `<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36">
                    <defs>
                        <radialGradient id="avatarGradient${type}">
                            <stop offset="0%" stop-color="${config.bg}" />
                            <stop offset="100%" stop-color="${type === 'user' ? '#b8941f' : '#3e2723'}" />
                        </radialGradient>
                    </defs>
                    <circle cx="18" cy="18" r="16" fill="url(#avatarGradient${type})"/>
                    <text x="18" y="24" font-size="16" text-anchor="middle" fill="${config.text}" font-weight="bold" font-family="'Cinzel', serif">${config.letter}</text>
                </svg>`;
            },
            
            generateCharacterAvatar(character) {
                const colorMap = {
                    1: "#d4af37", // æ¸©æ–¯é¡¿ - é‡‘è‰²
                    2: "#8b7355", // ç§‘ç€ - é’é“œè‰²
                    3: "#c9b29a", // éœåå¾· - ç±³è‰²
                    4: "#7d9c6d", // æ ¼æ— - ç»¿è‰²
                    5: "#6d8b9c", // å¡ç‰¹ - è“è‰²
                    6: "#9c6d8b"  // å¥¥æ–¯æœ¬ - ç´«è‰²
                };
                
                const bgColor = colorMap[character.id] || "#5d4037";
                const letter = character.name.charAt(0);
                
                return `<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36">
                    <defs>
                        <radialGradient id="charGradient${character.id}">
                            <stop offset="0%" stop-color="${bgColor}" />
                            <stop offset="100%" stop-color="${this.darkenColor(bgColor, 20)}" />
                        </radialGradient>
                    </defs>
                    <circle cx="18" cy="18" r="16" fill="url(#charGradient${character.id})"/>
                    <text x="18" y="24" font-size="16" text-anchor="middle" fill="#f5e9d9" font-weight="bold" font-family="'Cinzel', serif">${letter}</text>
                </svg>`;
            },
            
            darkenColor(color, percent) {
                const num = parseInt(color.replace("#", ""), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) - amt;
                const G = (num >> 8 & 0x00FF) - amt;
                const B = (num & 0x0000FF) - amt;
                return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + 
                    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + 
                    (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
            },
            
            decorateMessage(message) {
                const decorations = [
                    { pattern: /æ•™å ‚/gi, replacement: 'â›ª' },
                    { pattern: /èˆä¼š/gi, replacement: 'ğŸ’ƒ' },
                    { pattern: /å©šå§»|ç»“å©š/gi, replacement: 'ğŸ’' },
                    { pattern: /åº„å›­/gi, replacement: 'ğŸ°' },
                    { pattern: /çº¿ç´¢/gi, replacement: 'ğŸ”' },
                    { pattern: /ç§˜å¯†/gi, replacement: 'ğŸ¤«' },
                    { pattern: /å±é™©/gi, replacement: 'âš ï¸' },
                    { pattern: /æœºä¼š/gi, replacement: 'ğŸ¯' },
                    { pattern: /æ—¶é—´/gi, replacement: 'â³' },
                    { pattern: /ä¿¡ä»¶/gi, replacement: 'âœ‰ï¸' },
                    { pattern: /è´¢å¯Œ/gi, replacement: 'ğŸ’°' },
                    { pattern: /è´µæ—/gi, replacement: 'ğŸ‘‘' }
                ];
                
                let decorated = message;
                decorations.forEach(item => {
                    decorated = decorated.replace(item.pattern, match => `${item.replacement}${match}`);
                });
                
                return decorated;
            }
        };

        // AIé›†æˆç³»ç»Ÿï¼ˆå¢å¼ºç‰ˆè§’è‰²æ‰®æ¼”ï¼‰
        const AISystem = {
            async init() {
                try {
                    console.log("ğŸ¤– åˆå§‹åŒ–AIè¿æ¥...");
                    
                    const testResult = await this.testAPI();
                    
                    if (testResult) {
                        gameState.aiConfig.isConnected = true;
                        document.getElementById('ai-status-text').textContent = 'AI:åœ¨çº¿';
                        document.getElementById('ai-status').classList.remove('disconnected');
                        
                        console.log("âœ… AIè¿æ¥æˆåŠŸ");
                        return true;
                    } else {
                        gameState.aiConfig.isConnected = false;
                        document.getElementById('ai-status-text').textContent = 'AI:ç¦»çº¿';
                        document.getElementById('ai-status').classList.add('disconnected');
                        
                        console.warn("âš ï¸ AIè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨å†…ç½®å“åº”");
                        return false;
                    }
                } catch (error) {
                    console.error("AIåˆå§‹åŒ–å¤±è´¥:", error);
                    gameState.aiConfig.isConnected = false;
                    document.getElementById('ai-status-text').textContent = 'AI:ç¦»çº¿';
                    document.getElementById('ai-status').classList.add('disconnected');
                    return false;
                }
            },
            
            async testAPI() {
                try {
                    const response = await fetch(`${gameState.aiConfig.apiUrl}/models`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${gameState.aiConfig.apiKey}`
                        }
                    });
                    
                    return response.ok;
                } catch (error) {
                    console.error("APIæµ‹è¯•å¤±è´¥:", error);
                    return false;
                }
            },
            
            // ä¸»å“åº”ç”Ÿæˆå‡½æ•°
            async generateAIResponse(userMessage) {
                try {
                    // æ£€æŸ¥æ˜¯å¦ç›´æ¥å‘ç‰¹å®šè§’è‰²è¯´è¯
                    const speakingToCharacter = this.detectSpeakingToCharacter(userMessage);
                    
                    // å¦‚æœç©å®¶ç›´æ¥å¯¹æŸä¸ªè§’è‰²è¯´è¯
                    if (speakingToCharacter) {
                        gameState.currentConversationCharacter = speakingToCharacter;
                        await this.generateCharacterResponse(userMessage, speakingToCharacter);
                        return;
                    }
                    
                    // å¦‚æœå·²ç»æœ‰å½“å‰å¯¹è¯è§’è‰²
                    if (gameState.currentConversationCharacter) {
                        await this.generateCharacterResponse(userMessage, gameState.currentConversationCharacter);
                        return;
                    }
                    
                    // å¦åˆ™ç”Ÿæˆæ¸¸æˆä¸»æŒçš„å›åº”
                    await this.generateNarratorResponse(userMessage);
                    
                } catch (error) {
                    console.error("AIå“åº”ç”Ÿæˆé”™è¯¯:", error);
                    MessageSystem.createMessage("æ¸¸æˆä¸»æŒ", 
                        "ğŸ‚ ç§‹é£è½»è½»å¹è¿‡ï¼Œå¸¦æ¥äº†æ–°çš„æ€ç»ªã€‚è®©æˆ‘ä»¬ç»§ç»­è¿™ä¸ªç¤¾äº¤å­£èŠ‚çš„æ•…äº‹å§ã€‚", 
                        "ai"
                    );
                }
            },
            
            // æ£€æµ‹ç©å®¶æ˜¯å¦åœ¨å¯¹ç‰¹å®šè§’è‰²è¯´è¯
            detectSpeakingToCharacter(userMessage) {
                const lowerMessage = userMessage.toLowerCase();
                
                for (const character of gameState.maleCharacters) {
                    const nameParts = character.name.toLowerCase().split(' ');
                    
                    // æ£€æŸ¥å…¨åã€å§“æ°æˆ–åå­—
                    if (lowerMessage.includes(character.name.toLowerCase()) ||
                        lowerMessage.includes(nameParts[0]) ||
                        lowerMessage.includes(character.title.toLowerCase())) {
                        return character;
                    }
                }
                
                return null;
            },
            
            // ç”Ÿæˆè§’è‰²å›åº”
            async generateCharacterResponse(userMessage, character) {
                // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
                const typingIndicator = this.createTypingIndicator(character.name);
                const chatArea = document.getElementById('chat-area');
                chatArea.appendChild(typingIndicator);
                
                ScrollManager.scrollToBottom();
                
                let response = "";
                
                if (gameState.aiConfig.useAI && gameState.aiConfig.isConnected) {
                    const aiResponse = await this.callCharacterAPI(userMessage, character);
                    if (aiResponse) {
                        response = this.sanitizeResponse(aiResponse);
                    } else {
                        response = this.generateBuiltInCharacterResponse(userMessage, character);
                    }
                } else {
                    response = this.generateBuiltInCharacterResponse(userMessage, character);
                }
                
                typingIndicator.remove();
                MessageSystem.createMessage(`${character.name}${character.title}`, response, "ai");
                
                // æ£€æŸ¥å¯¹è¯æ˜¯å¦è‡ªç„¶ç»“æŸ
                if (this.isConversationEnding(userMessage, response)) {
                    setTimeout(() => {
                        MessageSystem.createMessage("æ¸¸æˆä¸»æŒ",
                            "ğŸ’­ è°ˆè¯å‘Šä¸€æ®µè½ã€‚ä½ å¯ä»¥ç»§ç»­ä¸å…¶ä»–äººäº¤è°ˆï¼Œæˆ–é€‰æ‹©å…¶ä»–è¡ŒåŠ¨ã€‚",
                            "ai"
                        );
                        GameSystem.setCurrentConversationCharacter(null);
                    }, 1500);
                }
            },
            
            // ç”Ÿæˆæ¸¸æˆä¸»æŒçš„å™è¿°å›åº”
            async generateNarratorResponse(userMessage) {
                if (this.isAskingCoreSecret(userMessage)) {
                    const evasion = this.generateEvasionResponse();
                    MessageSystem.createMessage("æ¸¸æˆä¸»æŒ", evasion, "ai");
                    return;
                }
                
                const typingIndicator = this.createTypingIndicator("æ¸¸æˆä¸»æŒ");
                const chatArea = document.getElementById('chat-area');
                chatArea.appendChild(typingIndicator);
                
                ScrollManager.scrollToBottom();
                
                let response = "";
                
                if (gameState.aiConfig.useAI && gameState.aiConfig.isConnected) {
                    const aiResponse = await this.callNarratorAPI(userMessage);
                    if (aiResponse) {
                        response = this.sanitizeResponse(aiResponse);
                    } else {
                        response = this.generateBuiltInNarratorResponse(userMessage);
                    }
                } else {
                    response = this.generateBuiltInNarratorResponse(userMessage);
                }
                
                typingIndicator.remove();
                MessageSystem.createMessage("æ¸¸æˆä¸»æŒ", response, "ai");
                
                if (this.shouldAdvanceMonth(userMessage)) {
                    GameSystem.advanceMonth();
                }
            },
            
            // åˆ›å»ºæ‰“å­—æŒ‡ç¤ºå™¨
            createTypingIndicator(senderName) {
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'message ai-message';
                
                let avatarSvg = '';
                if (senderName === "æ¸¸æˆä¸»æŒ") {
                    avatarSvg = MessageSystem.generateAvatarSVG("ai", senderName);
                } else {
                    const character = gameState.maleCharacters.find(c => senderName.includes(c.name));
                    if (character) {
                        avatarSvg = MessageSystem.generateCharacterAvatar(character);
                    } else {
                        avatarSvg = MessageSystem.generateAvatarSVG("ai", senderName);
                    }
                }
                
                typingIndicator.innerHTML = `
                    <div class="message-sender">
                        <img src="data:image/svg+xml;utf8,${encodeURIComponent(avatarSvg)}" class="avatar" />
                        <span>${senderName}</span>
                        <div class="typing-indicator">
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                        </div>
                    </div>
                `;
                
                return typingIndicator;
            },
            
            // è°ƒç”¨è§’è‰²API
            async callCharacterAPI(userMessage, character) {
                if (!gameState.aiConfig.isConnected) return null;
                
                try {
                    const systemPrompt = this.buildCharacterSystemPrompt(character);
                    const recentHistory = this.getRecentConversationHistory();
                    
                    const messages = [
                        {
                            role: "system",
                            content: systemPrompt
                        }
                    ];
                    
                    if (recentHistory.length > 0) {
                        messages.push(...recentHistory);
                    }
                    
                    messages.push({
                        role: "user",
                        content: userMessage
                    });
                    
                    const requestBody = {
                        model: gameState.aiConfig.model,
                        messages: messages,
                        temperature: Math.min(0.9, gameState.aiConfig.creativity + 0.1), // è§’è‰²å¯¹è¯æ›´æœ‰åˆ›æ„
                        max_tokens: 500,
                        stream: false
                    };
                    
                    console.log(`ğŸ“¨ å‘é€${character.name}è§’è‰²å¯¹è¯è¯·æ±‚`);
                    
                    const response = await fetch(`${gameState.aiConfig.apiUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${gameState.aiConfig.apiKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.choices && data.choices[0]) {
                        console.log(`ğŸ“¬ æ”¶åˆ°${character.name}å“åº”`);
                        return data.choices[0].message.content;
                    }
                    
                    return null;
                    
                } catch (error) {
                    console.error("è§’è‰²APIè°ƒç”¨å¤±è´¥:", error);
                    return null;
                }
            },
            
            // æ„å»ºè§’è‰²ç³»ç»Ÿæç¤ºè¯
            buildCharacterSystemPrompt(character) {
                const playerName = gameState.character.name;
                const discoveryLevel = character.discoveryLevel;
                const relationship = character.relationship;
                const month = gameState.currentMonth;
                const season = gameState.season;
                
                return `ä½ æ˜¯${character.name}${character.title}ï¼Œ19ä¸–çºªè‹±å›½æ‘„æ”¿æ—¶æœŸçš„ç»…å£«ã€‚

# ä½ çš„èƒŒæ™¯
${character.description}
æ€§æ ¼ï¼š${character.personality}
è¯´è¯é£æ ¼ï¼š${character.speechStyle}

# å½“å‰æƒ…å¢ƒ
æ—¶é—´ï¼šç¬¬${month}ä¸ªæœˆï¼Œ${season}
åœ°ç‚¹ï¼šè‹±æ ¼å…°ä¹¡æ‘
å¯¹è¯å¯¹è±¡ï¼š${playerName}å°å§ï¼Œå­çˆµç‹¬å¥³
ä½ ä»¬çš„å…³ç³»ï¼š${this.getRelationshipDescription(relationship)}
${playerName}å¯¹ä½ çš„äº†è§£ç¨‹åº¦ï¼š${this.getDiscoveryDescription(discoveryLevel)}

# ä½ çš„ç§˜å¯†ï¼ˆç»å¯¹ä¸é€éœ²ï¼‰
- ä½ æœ‰éšè—çš„ç§˜å¯†ï¼Œä½†ç»ä¸èƒ½ç›´æ¥å‘Šè¯‰${playerName}
- å¦‚æœè¢«é—®åŠæ•æ„Ÿè¯é¢˜ï¼Œç¤¼è²Œåœ°è½¬ç§»è¯é¢˜æˆ–ç»™å‡ºæ¨¡ç³Šå›ç­”
- ä¿æŒç¬¦åˆä½ æ€§æ ¼çš„ååº”

# å¯¹è¯åŸåˆ™
1. **å½»åº•åŒ–èº«**ï¼šå®Œå…¨ä»£å…¥${character.name}çš„èº«ä»½ã€èƒŒæ™¯å’Œæ€§æ ¼
2. **ç¬¦åˆæ—¶ä»£**ï¼šä½¿ç”¨19ä¸–çºªè‹±å›½ä¸Šæµç¤¾ä¼šçš„è¯­è¨€å’Œç¤¼ä»ª
3. **ä¿æŒæ€§æ ¼**ï¼šè¯´è¯æ–¹å¼å¿…é¡»ç¬¦åˆ"${character.speechStyle}"
4. **é€‚åº¦å›åº”**ï¼šæ ¹æ®å…³ç³»äº²ç–å†³å®šå¼€æ”¾ç¨‹åº¦
5. **ä¸å‰§é€ç§˜å¯†**ï¼šç»ä¸é€éœ²è´¢åŠ¡çœŸç›¸ã€å©šå§»åŠ¨æœºç­‰æ ¸å¿ƒç§˜å¯†

# å›åº”è¦æ±‚
- æ¯æ¬¡å›åº”1-3å¥è¯
- ä¿æŒè‡ªç„¶æµç•…çš„å¯¹è¯
- å¯ä»¥æå‡ºé—®é¢˜å¼•å¯¼å¯¹è¯
- æ ¹æ®è¯é¢˜é€‚å½“å±•ç°æ€§æ ¼ç‰¹ç‚¹
- å¦‚æœæ„Ÿåˆ°è¢«å†’çŠ¯ï¼Œå¯ä»¥ç¤¼è²Œä½†åšå®šåœ°è¡¨è¾¾
- å¦‚æœå–œæ¬¢å¯¹æ–¹ï¼Œå¯ä»¥é€‚åº¦å±•ç°å¥½æ„Ÿä½†ä¿æŒçŸœæŒ

ç°åœ¨ï¼Œè¯·ä»¥${character.name}${character.title}çš„èº«ä»½å›åº”${playerName}å°å§çš„å¯¹è¯ã€‚`;
            },
            
            // æ„å»ºå™è¿°è€…ç³»ç»Ÿæç¤ºè¯
            async callNarratorAPI(userMessage) {
                if (!gameState.aiConfig.isConnected) return null;
                
                try {
                    const systemPrompt = this.buildStrictSystemPrompt();
                    const recentHistory = this.getRecentConversationHistory();
                    
                    const messages = [
                        {
                            role: "system",
                            content: systemPrompt
                        }
                    ];
                    
                    if (recentHistory.length > 0) {
                        messages.push(...recentHistory);
                    }
                    
                    messages.push({
                        role: "user",
                        content: userMessage
                    });
                    
                    const requestBody = {
                        model: gameState.aiConfig.model,
                        messages: messages,
                        temperature: gameState.aiConfig.creativity,
                        max_tokens: 800,
                        stream: false
                    };
                    
                    console.log("ğŸ“¨ å‘é€å™è¿°è€…è¯·æ±‚");
                    
                    const response = await fetch(`${gameState.aiConfig.apiUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${gameState.aiConfig.apiKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.choices && data.choices[0]) {
                        console.log("ğŸ“¬ æ”¶åˆ°å™è¿°è€…å“åº”");
                        return data.choices[0].message.content;
                    }
                    
                    return null;
                    
                } catch (error) {
                    console.error("å™è¿°è€…APIè°ƒç”¨å¤±è´¥:", error);
                    gameState.aiConfig.useAI = false;
                    return null;
                }
            },
            
            buildStrictSystemPrompt() {
                const character = gameState.character;
                const phase = gameState.currentPhase;
                const month = gameState.currentMonth;
                const season = gameState.season;
                
                const characterStatus = gameState.maleCharacters.map(c => 
                    `${c.name}${c.title}: ${c.status}, å¥½æ„Ÿåº¦: ${c.relationship}, æ¢ç´¢ç­‰çº§: ${c.discoveryLevel}`
                ).join('\n');
                
                const talents = character.talents.map(t => character.talentEffects[t]?.name || t).join(', ') || 'æ— ';
                
                return `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„19ä¸–çºªè‹±å›½æ‘„æ”¿æ—¶æœŸå°è¯´ä½œå®¶ï¼Œæ­£åœ¨ä¸»æŒã€Šå­çˆµå°å§çš„å©šäº‹ã€‹æ¸¸æˆã€‚

# æ¸¸æˆèƒŒæ™¯
æ—¶ä»£ï¼š19ä¸–çºªè‹±å›½æ‘„æ”¿æ—¶æœŸ
åœ°ç‚¹ï¼šè‹±æ ¼å…°ä¹¡æ‘
ä¸»è§’ï¼š${character.name}ï¼Œ${character.age}å²çš„å­çˆµç‹¬ç”Ÿå¥³
ç›®æ ‡ï¼šåœ¨12ä¸ªæœˆå†…é€šè¿‡å©šå§»æ‹¯æ•‘å®¶æ—æ¿’ä¸´ç ´äº§çš„é—äº§

# é‡è¦æ¸¸æˆè§„åˆ™ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰
1. ç§˜å¯†ä¿æŠ¤ï¼š6ä½ç”·æ€§ç»…å£«éƒ½æœ‰éšæœºç”Ÿæˆçš„éšè—ç§˜å¯†ï¼ˆè´¢åŠ¡çœŸç›¸ã€å©šå§»åŠ¨æœºã€éšè—æ—¶é™ã€å¥½è¿å¡ã€çˆ†é›·å¡ï¼‰ã€‚
2. ä¸¥ç¦å‰§é€ï¼šåœ¨ç©å®¶ä¸ç»…å£«è®¢å©šã€è§¦å‘å±æœºäº‹ä»¶æˆ–æ¸¸æˆç»ˆå±€å‰ï¼Œç»å¯¹ä¸èƒ½é€éœ²ä»»ä½•ç§˜å¯†å†…å®¹ã€‚
3. çº¿ç´¢å¯¼å‘ï¼šåªèƒ½æä¾›æŒ‡å‘å…·ä½“äº‹ä»¶ã€ç‰©å“æˆ–çŠ¶æ€çš„çº¿ç´¢ï¼Œä¸èƒ½ç›´æ¥è¯´å‡ºå¡ç‰Œåç§°æˆ–æ ¸å¿ƒç§˜å¯†ã€‚
4. é˜¶æ®µé™åˆ¶ï¼š
   - ç¬¬1-3è½®ï¼ˆç§‹å­£ï¼‰ï¼šåªèƒ½æä¾›è¡¨é¢è§‚å¯Ÿå’Œåˆæ­¥çº¿ç´¢
   - ç¬¬4-8è½®ï¼ˆå†¬å­£ï¼‰ï¼šå¯ä»¥æä¾›æ›´æ·±å…¥çš„äº’åŠ¨å’Œæš—ç¤º
   - ç¬¬9-11è½®ï¼ˆæ˜¥å­£ï¼‰ï¼šå¯ä»¥è®¨è®ºå©šå§»å¯èƒ½æ€§å’Œé£é™©è¯„ä¼°
   - ç¬¬12è½®ï¼ˆå¤å­£ï¼‰ï¼šå¯ä»¥æ­ç¤ºæœ€ç»ˆçœŸç›¸

# å½“å‰æ¸¸æˆçŠ¶æ€
- å½“å‰é˜¶æ®µï¼šç¬¬${month}/12è½®ï¼Œ${phase}
- å½“å‰å­£èŠ‚ï¼š${season}
- ä¸»è§’å¤©èµ‹ï¼š${talents}
- è¡ŒåŠ¨ç‚¹å‰©ä½™ï¼š${gameState.actionPoints}/${gameState.maxActionPoints}

# ç»…å£«ä»¬å½“å‰çŠ¶æ€
${characterStatus}

# ä½ çš„è§’è‰²
ä½ æ˜¯"æ¸¸æˆä¸»æŒ"ï¼Œè´Ÿè´£ï¼š
1. æè¿°åœºæ™¯å’Œç¯å¢ƒ
2. æ¨è¿›å‰§æƒ…å‘å±•
3. æä¾›æ¸¸æˆåé¦ˆ
4. ä¿æŒ19ä¸–çºªè‹±å›½ç¤¾äº¤ç¤¼ä»ªçš„å™äº‹é£æ ¼

# å¯¹è¯é£æ ¼è¦æ±‚
- ä½¿ç”¨19ä¸–çºªè‹±å›½ä¸Šæµç¤¾ä¼šçš„ä¼˜é›…è¯­è¨€
- ä¿æŒå™äº‹è¿è´¯æ€§ï¼Œè®°ä½ä¹‹å‰çš„å¯¹è¯å†…å®¹
- æ ¹æ®ç©å®¶çš„è¡ŒåŠ¨å’Œé—®é¢˜æä¾›å…·ä½“å›åº”
- ä¸è¦é‡å¤ç›¸åŒçš„å›åº”
- é€‚å½“ä½¿ç”¨ç¬¦åˆæ—¶ä»£èƒŒæ™¯çš„æ¯”å–»å’Œæè¿°

è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œç”Ÿæˆç¬¦åˆå½“å‰é˜¶æ®µã€è§’è‰²çŠ¶æ€å’Œç¤¾äº¤ç¤¼ä»ªçš„å›åº”ã€‚ä¿æŒæ–‡ç¬”ä¼˜ç¾ï¼Œç¬¦åˆ19ä¸–çºªé£æ ¼ï¼Œä½†ç»å¯¹ä¸è¦é€éœ²ä»»ä½•ç»…å£«çš„éšè—ç§˜å¯†ã€‚`;
            },
            
            // è¾…åŠ©å‡½æ•°
            getRelationshipDescription(level) {
                if (level < 10) return "åˆšåˆšè®¤è¯†ï¼Œä¿æŒç¤¼è²Œè·ç¦»";
                if (level < 30) return "æ™®é€šç†Ÿäººï¼Œå¯ä»¥é—²èŠ";
                if (level < 60) return "æœ‹å‹å…³ç³»ï¼Œè°ˆè¯æ›´æ”¾æ¾";
                if (level < 80) return "äº²å¯†æœ‹å‹ï¼Œå¯ä»¥è°ˆè®ºç§äº‹";
                return "éå¸¸äº²å¯†ï¼Œå‡ ä¹æ— è¯ä¸è°ˆ";
            },
            
            getDiscoveryDescription(level) {
                if (level === 0) return "å®Œå…¨ä¸äº†è§£";
                if (level === 1) return "çŸ¥é“åŸºæœ¬è¡¨é¢ä¿¡æ¯";
                if (level === 2) return "æœ‰ä¸€äº›åˆæ­¥è§‚å¯Ÿ";
                if (level === 3) return "äº†è§£éƒ¨åˆ†ç”Ÿæ´»ä¹ æƒ¯";
                if (level === 4) return "çŸ¥é“ä¸€äº›èƒŒæ™¯ä¿¡æ¯";
                return "ç›¸å½“äº†è§£";
            },
            
            getRecentConversationHistory() {
                const messages = [];
                const chatArea = document.getElementById('chat-area');
                const messageElements = chatArea.querySelectorAll('.message');
                
                const recentMessages = Array.from(messageElements).slice(-5);
                
                recentMessages.forEach(msg => {
                    const isUser = msg.classList.contains('user-message');
                    const sender = msg.querySelector('.message-sender span')?.textContent || (isUser ? gameState.character.name : "æ¸¸æˆä¸»æŒ");
                    const content = msg.querySelector('.message-content')?.textContent || "";
                    
                    if (content.trim()) {
                        messages.push({
                            role: isUser ? "user" : "assistant",
                            content: content
                        });
                    }
                });
                
                return messages;
            },
            
            sanitizeResponse(response) {
                const secretPhrases = [
                    "å®é™…ä¸Šä»–æ˜¯", "çœŸå®æƒ…å†µæ˜¯", "ç§˜å¯†åœ¨äº", "éšè—çš„çœŸç›¸",
                    "ä»–å®é™…ä¸Š", "èƒŒåçš„åŸå› æ˜¯", "ä¸ä¸ºäººçŸ¥çš„æ˜¯"
                ];
                
                let sanitized = response;
                secretPhrases.forEach(phrase => {
                    const regex = new RegExp(phrase + ".*?(?=[ã€‚ï¼ï¼Ÿ\n])", "g");
                    sanitized = sanitized.replace(regex, "è¿™éœ€è¦æ›´æ·±å…¥çš„äº†è§£æ‰èƒ½ç¡®å®šã€‚");
                });
                
                return sanitized;
            },
            
            isAskingCoreSecret(userMessage) {
                const secretKeywords = [
                    "çœŸå®è´¢åŠ¡çŠ¶å†µ", "çœŸæ­£åŠ¨æœº", "éšè—ç§˜å¯†", "èƒŒåçœŸç›¸",
                    "å®é™…ç›®çš„", "ä¸å¯å‘Šäºº", "æš—åœ°é‡Œ", "ç§å¯†è®¡åˆ’",
                    "æ ¸å¿ƒç§˜å¯†", "å‘½è¿æ¡£æ¡ˆ", "å¥½è¿å¡", "çˆ†é›·å¡"
                ];
                
                const lowerMessage = userMessage.toLowerCase();
                return secretKeywords.some(keyword => lowerMessage.includes(keyword.toLowerCase()));
            },
            
            generateEvasionResponse() {
                const evasions = [
                    "ğŸ‚ ç§‹é£è½»è½»æ‹‚è¿‡ï¼Œè¿™ä¸ªé—®é¢˜ä¼¼ä¹è§¦åŠäº†ç»…å£«ä»¬çš„éšç§è¾¹ç•Œã€‚åœ¨19ä¸–çºªçš„ç¤¾äº¤ç¤¼ä»ªä¸­ï¼Œæœ‰äº›è¯é¢˜éœ€è¦æ›´æ·±å…¥çš„ä¿¡ä»»æ‰èƒ½æ¢è®¨ã€‚",
                    "ğŸ’­ ä½ æ•é”åœ°æ„è¯†åˆ°ï¼Œè¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆå¯èƒ½éšè—åœ¨å±‚å±‚ç¤¾äº¤é¢å…·ä¹‹ä¸‹ã€‚ä¹Ÿè®¸é€šè¿‡æ›´å¤šçš„è§‚å¯Ÿå’Œäº’åŠ¨ï¼ŒçœŸç›¸ä¼šé€æ¸æµ®ç°ã€‚",
                    "ğŸ­ åœ¨æ‘„æ”¿æ—¶æœŸçš„è‹±æ ¼å…°ï¼Œç»…å£«ä»¬çš„çœŸå®å¤„å¢ƒå¾€å¾€åŒ…è£¹åœ¨å¾—ä½“çš„ä¸¾æ­¢å’Œæ°å½“çš„è¨€è¾ä¹‹ä¸­ã€‚ç»§ç»­æ¢ç´¢ï¼Œä½ ä¼šå‘ç°æ›´å¤šçº¿ç´¢ã€‚",
                    "ğŸ” è¿™æ˜¯ä¸ªæ·±åˆ»çš„é—®é¢˜ã€‚è®°ä½ï¼Œåœ¨å©šå§»å¸‚åœºä¸­ï¼ŒçœŸç›¸å¾€å¾€ä¸ä¼šè½»æ˜“å±•ç°ï¼Œå®ƒéœ€è¦æ—¶é—´å’Œæ™ºæ…§çš„æŒ–æ˜ã€‚"
                ];
                
                return evasions[Math.floor(Math.random() * evasions.length)];
            },
            
            generateBuiltInCharacterResponse(userMessage, character) {
                const lowerMessage = userMessage.toLowerCase();
                const playerName = gameState.character.name;
                
                // æ ¹æ®è§’è‰²ç±»å‹ç”Ÿæˆå›åº”
                switch(character.type) {
                    case "wealthy": // ç†æŸ¥å¾·Â·æ¸©æ–¯é¡¿
                        const richResponses = [
                            `ï¼ˆæ¸©æ–‡å°”é›…åœ°å¾®ç¬‘ï¼‰${playerName}å°å§ï¼Œæ‚¨å¯¹æŠ•èµ„æ„Ÿå…´è¶£å—ï¼Ÿæœ€è¿‘è¿æ²³è‚¡ç¥¨çš„è¡¨ç°ç›¸å½“ä¸é”™ã€‚`,
                            `æ…ˆå–„æ˜¯ç»…å£«çš„è´£ä»»ã€‚ä¸Šå‘¨æˆ‘åˆšåˆšä¸ºæ•™åŒºå­¦æ ¡æèµ äº†ä¸€æ‰¹æ–°è¯¾æœ¬ã€‚`,
                            `æ„å¤§åˆ©èŠ±å›­åœ¨ç§‹å­£åˆ«æœ‰ä¸€ç•ªé£å‘³ï¼Œå¦‚æœæ‚¨æœ‰å…´è¶£ï¼Œæ¬¢è¿æ¥å‚è§‚ã€‚`
                        ];
                        return richResponses[Math.floor(Math.random() * richResponses.length)];
                        
                    case "military": // çˆ±å¾·åÂ·ç§‘ç€
                        const militaryResponses = [
                            `ï¼ˆæŒºç›´èº«æ¿ï¼‰åœ¨å†›é˜Ÿé‡Œï¼Œçºªå¾‹å’Œè£èª‰é«˜äºä¸€åˆ‡ã€‚`,
                            `æˆ˜äº‰æ•™ä¼šäº†æˆ‘çæƒœå’Œå¹³çš„æ—¥å¸¸ã€‚æ‚¨è§‰å¾—ä»Šå¤©çš„å¤©æ°”å¦‚ä½•ï¼Ÿ`,
                            `ç®€çŸ­çš„å›åº”å¾€å¾€æœ€æœ‰æ•ˆã€‚æ‚¨ä»Šå¤©æ°”è‰²ä¸é”™ã€‚`
                        ];
                        return militaryResponses[Math.floor(Math.random() * militaryResponses.length)];
                        
                    case "noble": // æŸ¥ç†Â·éœåå¾·
                        const nobleResponses = [
                            `ï¼ˆä¼˜é›…åœ°é èº¬ï¼‰å®¶çˆ¶å¸¸è¯´ï¼ŒçœŸæ­£çš„è´µæ—ä¸åœ¨äºå¤´è¡”ï¼Œè€Œåœ¨äºå“è¡Œã€‚`,
                            `èå£«æ¯”äºšçš„åå››è¡Œè¯—å¾ˆé€‚åˆè¿™ä¸ªå­£èŠ‚ï¼Œæ‚¨è§‰å¾—å‘¢ï¼Ÿ`,
                            `æ¸©æ³‰ç¤¾äº¤å­£æ€»æ˜¯è®©äººæ„‰æ‚¦ã€‚æ‚¨å–œæ¬¢å·´æ–¯çš„æ¸©æ³‰å—ï¼Ÿ`
                        ];
                        return nobleResponses[Math.floor(Math.random() * nobleResponses.length)];
                        
                    case "practical": // å¡ç¼ªå°”Â·æ ¼æ—
                        const farmerResponses = [
                            `ä»Šå¹´çš„æ”¶æˆä¸é”™ï¼Œå°éº¦ä»·æ ¼å¾ˆç¨³å®šã€‚`,
                            `æˆ‘å¦¹å¦¹è¯´æƒ³é‚€è¯·æ‚¨æ¥å®¶é‡Œå–èŒ¶ï¼Œå¥¹çƒ¤çš„å¸åº·é¥¼å¾ˆå¥½åƒã€‚`,
                            `å†œåœºçš„ç”Ÿæ´»å¾ˆç®€å•ï¼Œä½†å¾ˆå……å®ã€‚æ‚¨å–œæ¬¢ä¹¡æ‘ç”Ÿæ´»å—ï¼Ÿ`
                        ];
                        return farmerResponses[Math.floor(Math.random() * farmerResponses.length)];
                        
                    case "intellectual": // å¨å»‰Â·å¡ç‰¹
                        const lawyerResponses = [
                            `ï¼ˆçœ¼ç›ä¸€äº®ï¼‰æœ€è¿‘è®®ä¼šé€šè¿‡çš„æ–°æ³•æ¡ˆå¾ˆæœ‰æ„æ€ï¼Œæ‚¨æœ‰å…³æ³¨å—ï¼Ÿ`,
                            `æ³•å¾‹æ˜¯æ–‡æ˜çš„åŸºçŸ³ã€‚å¯¹äº†ï¼Œæˆ‘æœ€è¿‘åœ¨è¯»äºšå½“Â·æ–¯å¯†çš„ã€Šå›½å¯Œè®ºã€‹ã€‚`,
                            `ä¼¦æ•¦å’Œä¹¡æ‘å¾ˆä¸ä¸€æ ·ï¼Œå„æœ‰å„çš„é­…åŠ›ã€‚æ‚¨æ›´å–œæ¬¢å“ªé‡Œï¼Ÿ`
                        ];
                        return lawyerResponses[Math.floor(Math.random() * lawyerResponses.length)];
                        
                    case "mysterious": // ä¹”æ²»Â·å¥¥æ–¯æœ¬
                        const mysteriousResponses = [
                            `ï¼ˆè‹¥æœ‰æ‰€æ€ï¼‰æ¯äº²å¸¸è¯´ï¼Œå®‰é™çš„ç”Ÿæ´»æœ€æœ‰ä»·å€¼ã€‚`,
                            `æ•™å ‚çš„å½©ç»˜ç»ç’ƒåœ¨é˜³å…‰ä¸‹å¾ˆç¾ï¼Œä¸æ˜¯å—ï¼Ÿ`,
                            `æœ‰æ—¶å€™ï¼Œå°‘è¯´æ¯”å¤šè¯´æ›´å¥½ã€‚æ‚¨è§‰å¾—å‘¢ï¼Ÿ`
                        ];
                        return mysteriousResponses[Math.floor(Math.random() * mysteriousResponses.length)];
                        
                    default:
                        return `å¾ˆé«˜å…´ä¸æ‚¨äº¤è°ˆï¼Œ${playerName}å°å§ã€‚`;
                }
            },
            
            generateBuiltInNarratorResponse(userMessage) {
                const lowerMessage = userMessage.toLowerCase();
                
                const phaseResponses = {
                    "æƒ…æŠ¥æ”¶é›†æœŸ": [
                        "ğŸ‚ ç§‹å­£çš„èˆä¼šå­£èŠ‚åˆšåˆšå¼€å§‹ï¼Œè¿™æ˜¯è§‚å¯Ÿå’Œäº†è§£ç»…å£«ä»¬çš„å¥½æ—¶æœºã€‚",
                        "ğŸ’ƒ ç¤¾äº¤åœºåˆä¸­ï¼Œæ¯ä¸ªäººçš„è¡¨ç°éƒ½å€¼å¾—ä»”ç»†å“å‘³ã€‚ä½ æ³¨æ„åˆ°äº†ä»€ä¹ˆç»†èŠ‚ï¼Ÿ",
                        "ğŸ‘‚ åŠé—´ä¼ è¨€æœ‰æ—¶èƒ½æä¾›æœ‰è¶£çš„ä¿¡æ¯ï¼Œä½†éœ€è¦è°¨æ…ç”„åˆ«ã€‚"
                    ],
                    "æ·±åº¦äº¤å¾€æœŸ": [
                        "â„ï¸ å†¬å­£çš„å®¤å†…ç¤¾äº¤æä¾›äº†æ›´æ·±å…¥çš„äº¤æµæœºä¼šã€‚å…³ç³»æ­£åœ¨é€æ¸å‘å±•ã€‚",
                        "ğŸ”¥ å£ç‚‰æ—çš„è°ˆè¯å¾€å¾€æ¯”èˆä¼šä¸Šçš„æ›´çœŸå®ã€‚ä½ å¸Œæœ›äº†è§£å“ªä¸€æ–¹é¢ï¼Ÿ",
                        "ğŸ“š è¿™ä¸ªå­£èŠ‚é€‚åˆæ›´ç§å¯†çš„äº’åŠ¨å’Œä¿¡ä»¶å¾€æ¥ã€‚"
                    ],
                    "æ±‚å©šçª—å£æœŸ": [
                        "ğŸŒ¸ æ˜¥å¤©æ˜¯æ±‚å©šçš„å­£èŠ‚ï¼Œå…³ç³»éœ€è¦åšå‡ºå†³å®šæ€§çš„è¿›å±•ã€‚",
                        "ğŸ’ å©šå§»çš„è€ƒè™‘å˜å¾—æ›´åŠ å®é™…ï¼Œéœ€è¦æƒè¡¡å„ç§å› ç´ ã€‚",
                        "âš–ï¸ è¿™æ˜¯ä¸ªé‡è¦çš„å†³ç­–æ—¶åˆ»ï¼Œéœ€è¦æ™ºæ…§å’Œå‹‡æ°”ã€‚"
                    ],
                    "ç»ˆå±€æ­æ™“æœŸ": [
                        "â˜€ï¸ å¤å­£ç»ˆå±€ï¼Œæ‰€æœ‰çš„é€‰æ‹©å’Œç»“æœéƒ½å°†æ­æ™“ã€‚",
                        "ğŸ­ çœŸç›¸å¾€å¾€éšè—åœ¨è¡¨è±¡ä¹‹ä¸‹ï¼Œç°åœ¨æ˜¯æœ€å…³é”®çš„æ­ç¤ºæ—¶åˆ»ã€‚",
                        "â³ æ—¶é—´ä¸ç­‰äººï¼Œå¿…é¡»åšå‡ºæœ€ç»ˆå†³å®šã€‚"
                    ]
                };
                
                const characterNames = ["ç†æŸ¥å¾·", "æ¸©æ–¯é¡¿", "çˆ±å¾·å", "ç§‘ç€", "æŸ¥ç†", "éœåå¾·", 
                                      "å¡ç¼ªå°”", "æ ¼æ—", "å¨å»‰", "å¡ç‰¹", "ä¹”æ²»", "å¥¥æ–¯æœ¬"];
                
                for (const name of characterNames) {
                    if (lowerMessage.includes(name.toLowerCase())) {
                        return this.generateCharacterIntroduction(name);
                    }
                }
                
                if (lowerMessage.includes("ç¤¾äº¤") || lowerMessage.includes("èˆä¼š") || lowerMessage.includes("èŒ¶ä¼š")) {
                    return "ğŸ’ƒ æœ¬æœˆçš„ç¤¾äº¤æ´»åŠ¨æä¾›äº†è§‚å¯Ÿç»…å£«ä»¬çš„æœºä¼šã€‚ä½ æƒ³é‡ç‚¹äº†è§£å“ªä¸€ä½ï¼Ÿ";
                }
                
                if (lowerMessage.includes("æ‹œè®¿") || lowerMessage.includes("å®…é‚¸")) {
                    return "ğŸšª æ­£å¼æ‹œè®¿èƒ½è®©ä½ çœ‹åˆ°ç»…å£«ä»¬æ›´çœŸå®çš„ä¸€é¢ã€‚é€‰æ‹©æ‹œè®¿å¯¹è±¡éœ€è¦è°¨æ…è€ƒè™‘ã€‚";
                }
                
                if (lowerMessage.includes("ä¿¡ä»¶") || lowerMessage.includes("å†™ä¿¡")) {
                    return "âœ‰ï¸ ä¹¦ä¿¡å¾€æ¥æ˜¯æ·‘å¥³ä¸ç»…å£«é—´å¾—ä½“çš„äº¤æµæ–¹å¼ï¼Œä¹Ÿèƒ½é€éœ²å‡ºæ€§æ ¼å’Œå“å‘³ã€‚";
                }
                
                if (lowerMessage.includes("æ¯äº²") || lowerMessage.includes("å¦ˆå¦ˆ")) {
                    return "ğŸ‘©â€ğŸ¦³ æ¯äº²çš„äººè„‰å’Œç»éªŒèƒ½æä¾›æœ‰ä»·å€¼çš„èƒŒæ™¯ä¿¡æ¯ï¼Œä½†è®°å¾—ä¿æŒåˆ¤æ–­åŠ›ã€‚";
                }
                
                if (lowerMessage.includes("å¥³ä»†") || lowerMessage.includes("çå¦®")) {
                    return "ğŸ‘©ğŸ» ä»†äººä»¬ä¹‹é—´çš„äº¤æµæœ‰æ—¶èƒ½æä¾›ç‹¬ç‰¹çš„è§†è§’ï¼Œä½†æ¶ˆæ¯éœ€è¦æ ¸å®ã€‚";
                }
                
                const phaseResponse = phaseResponses[gameState.currentPhase];
                if (phaseResponse) {
                    return phaseResponse[Math.floor(Math.random() * phaseResponse.length)];
                }
                
                return "ğŸ­ åœ¨æ‘„æ”¿æ—¶æœŸçš„ç¤¾äº¤èˆå°ä¸Šï¼Œæ¯ä¸ªé€‰æ‹©éƒ½å½±å“ç€æœªæ¥ã€‚ä½ å¸Œæœ›å¦‚ä½•ç»§ç»­ï¼Ÿ";
            },
            
            generateCharacterIntroduction(characterName) {
                const character = gameState.maleCharacters.find(c => 
                    c.name.includes(characterName) || characterName.includes(c.name.split(' ')[0])
                );
                
                if (!character) return "è¿™ä½ç»…å£«ä¼¼ä¹ä¸åœ¨å½“å‰çš„ç¤¾äº¤åœˆä¸­ã€‚";
                
                const responses = [
                    `ğŸ’° ${character.name}${character.title}åœ¨ç¤¾äº¤åœºåˆä¸­æ€»æ˜¯å¼•äººæ³¨ç›®ï¼Œä»–çš„${character.description.split('ï¼Œ')[1] || "ä¸¾æ­¢å¾—ä½“"}`,
                    `ğŸ’­ å…³äº${character.name}${character.title}ï¼Œç¤¾äº¤åœˆä¸­æœ‰å„ç§è®®è®ºï¼Œä½†çœŸç›¸éœ€è¦äº²è‡ªäº†è§£`,
                    `ğŸ© ${character.name}${character.title}çš„èƒŒæ™¯å’Œç°çŠ¶éƒ½å€¼å¾—ä»”ç»†è€ƒå¯Ÿï¼Œç‰¹åˆ«æ˜¯åœ¨å©šå§»çš„è€ƒé‡ä¸­`
                ];
                
                return responses[Math.floor(Math.random() * responses.length)];
            },
            
            shouldAdvanceMonth(userMessage) {
                if (gameState.currentMonth >= 12) return false;
                
                const significantActions = userMessage.length > 30 || 
                    userMessage.includes("å†³å®š") || 
                    userMessage.includes("é€‰æ‹©") ||
                    userMessage.includes("æ¥å—") ||
                    userMessage.includes("æ‹’ç»");
                
                return significantActions && Math.random() > 0.8;
            },
            
            isConversationEnding(userMessage, characterResponse) {
                // ç®€å•çš„å¯¹è¯ç»“æŸæ£€æµ‹
                const endingPhrases = ["å†è§", "å‘Šè¾", "ä¸‹æ¬¡èŠ", "å¾ˆé«˜å…´äº¤è°ˆ", "è¯¥èµ°äº†"];
                const userEnding = endingPhrases.some(phrase => userMessage.includes(phrase));
                const charEnding = endingPhrases.some(phrase => characterResponse.includes(phrase));
                
                return userEnding || charEnding || Math.random() > 0.9;
            }
        };

        // äº‹ä»¶ç›‘å¬å™¨è®¾ç½®
        function setupEventListeners() {
            document.getElementById('send-btn').addEventListener('click', handleUserMessage);
            
            document.getElementById('user-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleUserMessage();
                }
            });
            
            document.getElementById('ai-status').addEventListener('click', function() {
                const aiSettings = document.getElementById('ai-settings');
                const isVisible = aiSettings.style.display === 'block';
                aiSettings.style.display = isVisible ? 'none' : 'block';
                
                if (!isVisible) {
                    document.getElementById('ai-model').value = gameState.aiConfig.model;
                    document.getElementById('ai-creativity').value = gameState.aiConfig.creativity;
                }
            });
            
            document.getElementById('ai-save-btn').addEventListener('click', function() {
                saveAIConfig();
            });
            
            document.addEventListener('click', function(event) {
                const aiSettings = document.getElementById('ai-settings');
                const aiStatus = document.getElementById('ai-status');
                
                if (aiSettings.style.display === 'block' && 
                    !aiSettings.contains(event.target) && 
                    !aiStatus.contains(event.target)) {
                    aiSettings.style.display = 'none';
                }
            });
        }

        // å¤„ç†ç”¨æˆ·æ¶ˆæ¯
        async function handleUserMessage() {
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();
            
            if (message === '') return;
            
            MessageSystem.createMessage(gameState.character.name, message, "user");
            
            await AISystem.generateAIResponse(message);
            
            userInput.value = '';
            userInput.placeholder = gameState.currentConversationCharacter 
                ? `ä¸${gameState.currentConversationCharacter.name}${gameState.currentConversationCharacter.title}äº¤è°ˆ...`
                : "è¾“å…¥å¯¹è¯æˆ–é€‰æ‹©è¡ŒåŠ¨...";
        }

        // å¤„ç†è¡ŒåŠ¨é€‰æ‹©
        function handleAction(actionId) {
            const userInput = document.getElementById('user-input');
            
            const action = gameState.availableActions.find(a => a.id === actionId);
            if (action.cost > gameState.actionPoints) {
                MessageSystem.createMessage("æ¸¸æˆä¸»æŒ", 
                    "ğŸ•°ï¸ æœ¬æœˆçš„æ—¶é—´ç²¾åŠ›å·²ç»æ¶ˆè€—è¿‡å¤šï¼Œéœ€è¦ç­‰å¾…ä¸‹ä¸ªæœˆæ¢å¤ã€‚", 
                    "ai"
                );
                return;
            }
            
            switch(actionId) {
                case 'social':
                    userInput.value = "æˆ‘æƒ³äº†è§£æœ¬æœˆç¤¾äº¤æ´»åŠ¨çš„æƒ…å†µï¼Œç‰¹åˆ«æ˜¯å…³äº";
                    userInput.focus();
                    setTimeout(() => userInput.setSelectionRange(userInput.value.length, userInput.value.length));
                    break;
                case 'visit':
                    userInput.value = "æˆ‘æ‰“ç®—æ‹œè®¿æŸä½ç»…å£«ï¼Œè§‚å¯Ÿä»–çš„çœŸå®ç”Ÿæ´»ç¯å¢ƒã€‚";
                    break;
                case 'letter':
                    userInput.value = "æˆ‘æƒ³ç»™æŸä½ç»…å£«å†™ä¿¡ï¼Œäº†è§£ä»–çš„å“å‘³å’Œæ€æƒ³ã€‚";
                    break;
                case 'mother':
                    userInput.value = "æ¯äº²ï¼Œæ‚¨èƒ½å¸®æˆ‘æ‰“å¬ä¸€ä¸‹å…³äº";
                    userInput.focus();
                    setTimeout(() => userInput.setSelectionRange(userInput.value.length, userInput.value.length));
                    break;
                case 'maid':
                    userInput.value = "çå¦®ï¼Œæˆ‘éœ€è¦ä½ å¸®æˆ‘æ‰“å¬ä¸€äº›æ¶ˆæ¯...";
                    break;
                case 'chat':
                    userInput.value = "";
                    userInput.placeholder = "è¾“å…¥ä½ æƒ³è¯´çš„è¯æˆ–é—®é¢˜...";
                    userInput.focus();
                    // å¦‚æœå·²ç»æœ‰å¯¹è¯è§’è‰²ï¼Œæ¸…é™¤å®ƒ
                    GameSystem.setCurrentConversationCharacter(null);
                    break;
            }
        }

        // ä¿å­˜AIé…ç½®
        function saveAIConfig() {
            const creativity = document.getElementById('ai-creativity').value;
            
            gameState.aiConfig.creativity = parseFloat(creativity);
            
            document.getElementById('ai-settings').style.display = 'none';
            
            MessageSystem.createMessage("æ¸¸æˆä¸»æŒ", 
                "âš™ï¸ AIè®¾ç½®å·²æ›´æ–°ï¼Œåˆ›é€ åŠ›å‚æ•°å·²è°ƒæ•´ã€‚", 
                "ai"
            );
            
            return true;
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        async function initGame() {
            GameSystem.updateStatusDisplay();
            GameSystem.updateActionButtons();
            
            const aiConnected = await AISystem.init();
            
            MessageSystem.createMessage("æ¸¸æˆä¸»æŒ", 
                `âœ¨ã€Š${gameState.character.name}çš„å©šäº‹ã€‹â€”â€” å‘½è¿ç§˜å¯†æ¡£æ¡ˆç³»ç»Ÿå·²æ¿€æ´» âœ¨\n\n` +
                `ğŸ° æ‘„æ”¿æ—¶æœŸï¼Œè‹±æ ¼å…°ä¹¡æ‘\n` +
                `ğŸ‘¤ ${gameState.character.name}ï¼Œ${gameState.character.age}å²çš„å­çˆµç‹¬ç”Ÿå¥³\n` +
                `ğŸ’” å®¶æ—æ¿’ä¸´ç ´äº§ï¼Œå¿…é¡»åœ¨12ä¸ªæœˆå†…é€šè¿‡å©šå§»æ‹¯æ•‘é—äº§\n` +
                `ğŸ­ 6ä½ç»…å£«ï¼Œæ¯äººéƒ½æœ‰éšæœºç”Ÿæˆçš„éšè—ç§˜å¯†\n` +
                `ğŸ”’ ç§˜å¯†åœ¨è®¢å©šæˆ–å±æœºå‰ç»ä¸ä¼šç›´æ¥é€éœ²\n` +
                `ğŸ•µï¸â€â™€ï¸ ä½ éœ€è¦é€šè¿‡æ¢ç´¢å‘ç°çœŸç›¸ï¼Œåšå‡ºæ˜æ™ºé€‰æ‹©`,
                "ai"
            );
            
            setTimeout(() => {
                MessageSystem.createMessage("æ¸¸æˆä¸»æŒ", 
                    "ğŸ² **å‘½è¿ç§˜å¯†æ¡£æ¡ˆè§„åˆ™**\n\n" +
                    "â€¢ æ¯å±€æ¸¸æˆä¸º6ä½ç»…å£«éšæœºç”Ÿæˆç‹¬ç«‹ç§˜å¯†æ¡£æ¡ˆ\n" +
                    "â€¢ æ¯ä»½æ¡£æ¡ˆåŒ…å«ï¼šè´¢åŠ¡çœŸç›¸ + å©šå§»åŠ¨æœº + éšè—æ—¶é™ + å¥½è¿å¡ + çˆ†é›·å¡\n" +
                    "â€¢ ç§˜å¯†åœ¨è®¢å©šã€å±æœºäº‹ä»¶æˆ–ç»ˆå±€å‰ç»å¯¹ä¿å¯†\n" +
                    "â€¢ åªèƒ½é€šè¿‡çº¿ç´¢é€æ­¥æ¢ç´¢çœŸç›¸\n\n" +
                    "ğŸ‚ **å½“å‰é˜¶æ®µï¼šæƒ…æŠ¥æ”¶é›†æœŸï¼ˆç¬¬1-3è½®ï¼‰**\n" +
                    "ä½¿ç”¨è¡ŒåŠ¨ç‚¹è¿›è¡Œæ¢ç´¢ï¼Œæ”¶é›†åˆæ­¥çº¿ç´¢",
                    "ai"
                );
            }, 1500);
            
            setTimeout(() => {
                showInitialScene();
            }, 3000);
        }

        // æ˜¾ç¤ºåˆå§‹åœºæ™¯
        function showInitialScene() {
            MessageSystem.createMessage("æ¸¸æˆä¸»æŒ", 
                `â›ª **åœºæ™¯ï¼šåœ£ç›ä¸½æ•™å ‚ç¤¼æ‹œæ—¥**\n\n` +
                `æ™¨å…‰é€è¿‡å½©è‰²ç»ç’ƒçª—ï¼Œæ´’åœ¨å¤è€çš„çŸ³ç Œåœ°é¢ä¸Šã€‚ç©ºæ°”ä¸­å¼¥æ¼«ç€æ—§æ©¡æœ¨æ¤…ã€èœ‚èœ¡èœ¡çƒ›å’Œå¹²ç‡¥è–°è¡£è‰çš„æ··åˆæ°”æ¯ã€‚\n\n` +
                `ä½ ä¸çˆ¶æ¯ä¸€åŒååœ¨åšæ—å®¶æ—çš„ä¸“ç”¨é•¿æ¤…ä¸Šã€‚æ¯äº²è½»è§¦ä½ çš„æ‰‹è‡‚ï¼šã€${gameState.character.name}ï¼ŒèƒŒæŒºç›´ã€‚è®°ä½ï¼Œä»Šå¤©å…¨é•‡çš„ä½“é¢äººå®¶éƒ½ä¼šæ¥ï¼Œç‰¹åˆ«æ˜¯é‚£å‡ ä½å•èº«ç»…å£«...ã€å¥¹å£°éŸ³å‹å¾—æ›´ä½ï¼Œã€...è®°ä½æˆ‘ä»¬çš„å¤„å¢ƒï¼Œæ¯ä¸€ä¸ªç»†èŠ‚éƒ½å¯èƒ½å†³å®šå®¶æ—çš„å‘½è¿ã€‚ã€\n\n` +
                `çˆ¶äº²åœ¨ä¸€æ—æ²‰é»˜åœ°ç¿»ç€ã€Šå…¬ç¥·ä¹¦ã€‹ï¼Œä»–çš„æŒ‡èŠ‚å› ç”¨åŠ›è€Œå‘ç™½ã€‚`,
                "ai"
            );
            
            setTimeout(() => {
                MessageSystem.createMessage("æ¸¸æˆä¸»æŒ",
                    "ğŸ•°ï¸ ç¤¼æ‹œç»“æŸï¼Œäººä»¬åœ¨æ•™å ‚åº­é™¢é‡Œå±•å¼€å‘¨æ—¥çš„ç¤¾äº¤ä»ªå¼ã€‚é˜³å…‰ç©¿è¿‡æ¦†æ ‘å¶ï¼Œåœ¨åœ°é¢æŠ•ä¸‹æ–‘é©³å…‰å½±ã€‚\n\n" +
                    "ä½ æ·±å¸ä¸€å£æ°”ï¼Œè°ƒæ•´å¥½è£™æ‘†ï¼Œéšç€çˆ¶æ¯èµ°å‡ºæ•™å ‚ã€‚åº­é™¢é‡Œï¼Œå…­ä½æœªå©šç»…å£«å„è‡ªå½¢æˆäº†å°å°çš„ç¤¾äº¤åœˆï¼š",
                    "ai"
                );
            }, 1200);
            
            gameState.maleCharacters.forEach((character, index) => {
                setTimeout(() => {
                    MessageSystem.createMessage("æ¸¸æˆä¸»æŒ",
                        `${character.emoji} **${character.name}${character.title}** - ${character.description}`,
                        "ai"
                    );
                }, 1500 + (index * 600));
            });
            
            setTimeout(() => {
                MessageSystem.createMessage("æ¸¸æˆä¸»æŒ",
                    `\nğŸ‚ ç§‹é£æ‹‚è¿‡åº­é™¢ï¼Œå·èµ·å‡ ç‰‡é‡‘é»„è½å¶ã€‚æ¯äº²è½»æ¨ä½ ï¼šã€è¯¥å»æ‰“æ‹›å‘¼äº†ï¼Œ${gameState.character.name}ã€‚è®°ä½ï¼Œå¾®ç¬‘è¦çŸœæŒï¼Œè°ˆè¯è¦å¾—ä½“ã€‚ã€\n\n` +
                    `**ç°åœ¨ï¼Œä½ å¯ä»¥ï¼š**\n` +
                    `â€¢ ç›´æ¥ä¸æŸä½ç»…å£«äº¤è°ˆï¼ˆåœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥å¯¹è¯ï¼‰\n` +
                    `â€¢ ä½¿ç”¨ä¸Šæ–¹è¡ŒåŠ¨æŒ‰é’®è¿›è¡Œæ¢ç´¢\n` +
                    `â€¢ è¯¢é—®æ¸¸æˆä¸»æŒäº†è§£æ›´å¤šä¿¡æ¯`,
                    "ai"
                );
            }, 5500);
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            CharacterCreationManager.init();
            setupEventListeners();
            console.log("ğŸ® æ¸¸æˆåˆå§‹åŒ–å®Œæˆï¼Œå‘½è¿ç§˜å¯†æ¡£æ¡ˆç³»ç»Ÿå·²å°±ç»ª");
            console.log("ğŸ¤– AIé…ç½®:", gameState.aiConfig.model, "(å¯†é’¥å·²å®‰å…¨åµŒå…¥)");
            console.log("ğŸ‘¥ è§’è‰²æ‰®æ¼”ç³»ç»Ÿå·²æ¿€æ´»ï¼šç©å®¶å¯ç›´æ¥ä¸ç»…å£«ä»¬å¯¹è¯");
        };
    </script>
</body>
</html>